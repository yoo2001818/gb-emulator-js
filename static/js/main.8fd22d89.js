/*! For license information please see main.8fd22d89.js.LICENSE.txt */
!function(){var t={842:function(t,e,r){t.exports=function t(e,r,n){function i(s,o){if(!r[s]){if(!e[s]){if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[s]={exports:{}};e[s][0].call(u.exports,(function(t){var r=e[s][1][t];return i(r||t)}),u,u.exports,t,e,r,n)}return r[s].exports}for(var a=void 0,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,n){(function(t){"use strict";var r,n,i=t.MutationObserver||t.WebKitMutationObserver;if(i){var a=0,s=new i(l),o=t.document.createTextNode("");s.observe(o,{characterData:!0}),r=function(){o.data=a=++a%2}}else if(t.setImmediate||"undefined"===typeof t.MessageChannel)r="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){l(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(l,0)};else{var c=new t.MessageChannel;c.port1.onmessage=l,r=function(){c.port2.postMessage(0)}}var u=[];function l(){var t,e;n=!0;for(var r=u.length;r;){for(e=u,u=[],t=-1;++t<r;)e[t]();r=u.length}n=!1}function h(t){1!==u.push(t)||n||r()}e.exports=h}).call(this,"undefined"!==typeof r.g?r.g:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{})},{}],2:[function(t,e,r){"use strict";var n=t(1);function i(){}var a={},s=["REJECTED"],o=["FULFILLED"],c=["PENDING"];function u(t){if("function"!==typeof t)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,t!==i&&d(this,t)}function l(t,e,r){this.promise=t,"function"===typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"===typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function h(t,e,r){n((function(){var n;try{n=e(r)}catch(i){return a.reject(t,i)}n===t?a.reject(t,new TypeError("Cannot resolve promise with itself")):a.resolve(t,n)}))}function f(t){var e=t&&t.then;if(t&&("object"===typeof t||"function"===typeof t)&&"function"===typeof e)return function(){e.apply(t,arguments)}}function d(t,e){var r=!1;function n(e){r||(r=!0,a.reject(t,e))}function i(e){r||(r=!0,a.resolve(t,e))}function s(){e(i,n)}var o=v(s);"error"===o.status&&n(o.value)}function v(t,e){var r={};try{r.value=t(e),r.status="success"}catch(n){r.status="error",r.value=n}return r}function p(t){return t instanceof this?t:a.resolve(new this(i),t)}function g(t){var e=new this(i);return a.reject(e,t)}function m(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var r=t.length,n=!1;if(!r)return this.resolve([]);for(var s=new Array(r),o=0,c=-1,u=new this(i);++c<r;)l(t[c],c);return u;function l(t,i){function c(t){s[i]=t,++o!==r||n||(n=!0,a.resolve(u,s))}e.resolve(t).then(c,(function(t){n||(n=!0,a.reject(u,t))}))}}function y(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var r=t.length,n=!1;if(!r)return this.resolve([]);for(var s=-1,o=new this(i);++s<r;)c(t[s]);return o;function c(t){e.resolve(t).then((function(t){n||(n=!0,a.resolve(o,t))}),(function(t){n||(n=!0,a.reject(o,t))}))}}e.exports=u,u.prototype.catch=function(t){return this.then(null,t)},u.prototype.then=function(t,e){if("function"!==typeof t&&this.state===o||"function"!==typeof e&&this.state===s)return this;var r=new this.constructor(i);return this.state!==c?h(r,this.state===o?t:e,this.outcome):this.queue.push(new l(r,t,e)),r},l.prototype.callFulfilled=function(t){a.resolve(this.promise,t)},l.prototype.otherCallFulfilled=function(t){h(this.promise,this.onFulfilled,t)},l.prototype.callRejected=function(t){a.reject(this.promise,t)},l.prototype.otherCallRejected=function(t){h(this.promise,this.onRejected,t)},a.resolve=function(t,e){var r=v(f,e);if("error"===r.status)return a.reject(t,r.value);var n=r.value;if(n)d(t,n);else{t.state=o,t.outcome=e;for(var i=-1,s=t.queue.length;++i<s;)t.queue[i].callFulfilled(e)}return t},a.reject=function(t,e){t.state=s,t.outcome=e;for(var r=-1,n=t.queue.length;++r<n;)t.queue[r].callRejected(e);return t},u.resolve=p,u.reject=g,u.all=m,u.race=y},{1:1}],3:[function(t,e,n){(function(e){"use strict";"function"!==typeof e.Promise&&(e.Promise=t(2))}).call(this,"undefined"!==typeof r.g?r.g:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{})},{2:2}],4:[function(t,e,r){"use strict";var n="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(){try{if("undefined"!==typeof indexedDB)return indexedDB;if("undefined"!==typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!==typeof mozIndexedDB)return mozIndexedDB;if("undefined"!==typeof OIndexedDB)return OIndexedDB;if("undefined"!==typeof msIndexedDB)return msIndexedDB}catch(t){return}}var s=a();function o(){try{if(!s||!s.open)return!1;var t="undefined"!==typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),e="function"===typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!t||e)&&"undefined"!==typeof indexedDB&&"undefined"!==typeof IDBKeyRange}catch(r){return!1}}function c(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(i){if("TypeError"!==i.name)throw i;for(var r=new("undefined"!==typeof BlobBuilder?BlobBuilder:"undefined"!==typeof MSBlobBuilder?MSBlobBuilder:"undefined"!==typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<t.length;n+=1)r.append(t[n]);return r.getBlob(e.type)}}"undefined"===typeof Promise&&t(3);var u=Promise;function l(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}function h(t,e,r){"function"===typeof e&&t.then(e),"function"===typeof r&&t.catch(r)}function f(t){return"string"!==typeof t&&(console.warn(t+" used as a key, but it is not a string."),t=String(t)),t}function d(){if(arguments.length&&"function"===typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var v="local-forage-detect-blob-support",p=void 0,g={},m=Object.prototype.toString,y="readonly",b="readwrite";function k(t){for(var e=t.length,r=new ArrayBuffer(e),n=new Uint8Array(r),i=0;i<e;i++)n[i]=t.charCodeAt(i);return r}function w(t){return new u((function(e){var r=t.transaction(v,b),n=c([""]);r.objectStore(v).put(n,"key"),r.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1)},r.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);e(r||!t||parseInt(t[1],10)>=43)}})).catch((function(){return!1}))}function S(t){return"boolean"===typeof p?u.resolve(p):w(t).then((function(t){return p=t}))}function E(t){var e=g[t.name],r={};r.promise=new u((function(t,e){r.resolve=t,r.reject=e})),e.deferredOperations.push(r),e.dbReady?e.dbReady=e.dbReady.then((function(){return r.promise})):e.dbReady=r.promise}function C(t){var e=g[t.name].deferredOperations.pop();if(e)return e.resolve(),e.promise}function D(t,e){var r=g[t.name].deferredOperations.pop();if(r)return r.reject(e),r.promise}function _(t,e){return new u((function(r,n){if(g[t.name]=g[t.name]||z(),t.db){if(!e)return r(t.db);E(t),t.db.close()}var i=[t.name];e&&i.push(t.version);var a=s.open.apply(s,i);e&&(a.onupgradeneeded=function(e){var r=a.result;try{r.createObjectStore(t.storeName),e.oldVersion<=1&&r.createObjectStore(v)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+t.name+'" has been upgraded from version '+e.oldVersion+" to version "+e.newVersion+', but the storage "'+t.storeName+'" already exists.')}}),a.onerror=function(t){t.preventDefault(),n(a.error)},a.onsuccess=function(){var e=a.result;e.onversionchange=function(t){t.target.close()},r(e),C(t)}}))}function B(t){return _(t,!1)}function I(t){return _(t,!0)}function A(t,e){if(!t.db)return!0;var r=!t.db.objectStoreNames.contains(t.storeName),n=t.version<t.db.version,i=t.version>t.db.version;if(n&&(t.version!==e&&console.warn('The database "'+t.name+"\" can't be downgraded from version "+t.db.version+" to version "+t.version+"."),t.version=t.db.version),i||r){if(r){var a=t.db.version+1;a>t.version&&(t.version=a)}return!0}return!1}function M(t){return new u((function(e,r){var n=new FileReader;n.onerror=r,n.onloadend=function(r){var n=btoa(r.target.result||"");e({__local_forage_encoded_blob:!0,data:n,type:t.type})},n.readAsBinaryString(t)}))}function R(t){return c([k(atob(t.data))],{type:t.type})}function T(t){return t&&t.__local_forage_encoded_blob}function L(t){var e=this,r=e._initReady().then((function(){var t=g[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}));return h(r,t,t),r}function x(t){E(t);for(var e=g[t.name],r=e.forages,n=0;n<r.length;n++){var i=r[n];i._dbInfo.db&&(i._dbInfo.db.close(),i._dbInfo.db=null)}return t.db=null,B(t).then((function(e){return t.db=e,A(t)?I(t):e})).then((function(n){t.db=e.db=n;for(var i=0;i<r.length;i++)r[i]._dbInfo.db=n})).catch((function(e){throw D(t,e),e}))}function O(t,e,r,n){void 0===n&&(n=1);try{var i=t.db.transaction(t.storeName,e);r(null,i)}catch(a){if(n>0&&(!t.db||"InvalidStateError"===a.name||"NotFoundError"===a.name))return u.resolve().then((function(){if(!t.db||"NotFoundError"===a.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),I(t)})).then((function(){return x(t).then((function(){O(t,e,r,n-1)}))})).catch(r);r(a)}}function z(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function j(t){var e=this,r={db:null};if(t)for(var n in t)r[n]=t[n];var i=g[r.name];i||(i=z(),g[r.name]=i),i.forages.push(e),e._initReady||(e._initReady=e.ready,e.ready=L);var a=[];function s(){return u.resolve()}for(var o=0;o<i.forages.length;o++){var c=i.forages[o];c!==e&&a.push(c._initReady().catch(s))}var l=i.forages.slice(0);return u.all(a).then((function(){return r.db=i.db,B(r)})).then((function(t){return r.db=t,A(r,e._defaultConfig.version)?I(r):t})).then((function(t){r.db=i.db=t,e._dbInfo=r;for(var n=0;n<l.length;n++){var a=l[n];a!==e&&(a._dbInfo.db=r.db,a._dbInfo.version=r.version)}}))}function N(t,e){var r=this;t=f(t);var n=new u((function(e,n){r.ready().then((function(){O(r._dbInfo,y,(function(i,a){if(i)return n(i);try{var s=a.objectStore(r._dbInfo.storeName).get(t);s.onsuccess=function(){var t=s.result;void 0===t&&(t=null),T(t)&&(t=R(t)),e(t)},s.onerror=function(){n(s.error)}}catch(o){n(o)}}))})).catch(n)}));return l(n,e),n}function P(t,e){var r=this,n=new u((function(e,n){r.ready().then((function(){O(r._dbInfo,y,(function(i,a){if(i)return n(i);try{var s=a.objectStore(r._dbInfo.storeName).openCursor(),o=1;s.onsuccess=function(){var r=s.result;if(r){var n=r.value;T(n)&&(n=R(n));var i=t(n,r.key,o++);void 0!==i?e(i):r.continue()}else e()},s.onerror=function(){n(s.error)}}catch(c){n(c)}}))})).catch(n)}));return l(n,e),n}function F(t,e,r){var n=this;t=f(t);var i=new u((function(r,i){var a;n.ready().then((function(){return a=n._dbInfo,"[object Blob]"===m.call(e)?S(a.db).then((function(t){return t?e:M(e)})):e})).then((function(e){O(n._dbInfo,b,(function(a,s){if(a)return i(a);try{var o=s.objectStore(n._dbInfo.storeName);null===e&&(e=void 0);var c=o.put(e,t);s.oncomplete=function(){void 0===e&&(e=null),r(e)},s.onabort=s.onerror=function(){var t=c.error?c.error:c.transaction.error;i(t)}}catch(u){i(u)}}))})).catch(i)}));return l(i,r),i}function U(t,e){var r=this;t=f(t);var n=new u((function(e,n){r.ready().then((function(){O(r._dbInfo,b,(function(i,a){if(i)return n(i);try{var s=a.objectStore(r._dbInfo.storeName).delete(t);a.oncomplete=function(){e()},a.onerror=function(){n(s.error)},a.onabort=function(){var t=s.error?s.error:s.transaction.error;n(t)}}catch(o){n(o)}}))})).catch(n)}));return l(n,e),n}function W(t){var e=this,r=new u((function(t,r){e.ready().then((function(){O(e._dbInfo,b,(function(n,i){if(n)return r(n);try{var a=i.objectStore(e._dbInfo.storeName).clear();i.oncomplete=function(){t()},i.onabort=i.onerror=function(){var t=a.error?a.error:a.transaction.error;r(t)}}catch(s){r(s)}}))})).catch(r)}));return l(r,t),r}function H(t){var e=this,r=new u((function(t,r){e.ready().then((function(){O(e._dbInfo,y,(function(n,i){if(n)return r(n);try{var a=i.objectStore(e._dbInfo.storeName).count();a.onsuccess=function(){t(a.result)},a.onerror=function(){r(a.error)}}catch(s){r(s)}}))})).catch(r)}));return l(r,t),r}function G(t,e){var r=this,n=new u((function(e,n){t<0?e(null):r.ready().then((function(){O(r._dbInfo,y,(function(i,a){if(i)return n(i);try{var s=a.objectStore(r._dbInfo.storeName),o=!1,c=s.openKeyCursor();c.onsuccess=function(){var r=c.result;r?0===t||o?e(r.key):(o=!0,r.advance(t)):e(null)},c.onerror=function(){n(c.error)}}catch(u){n(u)}}))})).catch(n)}));return l(n,e),n}function V(t){var e=this,r=new u((function(t,r){e.ready().then((function(){O(e._dbInfo,y,(function(n,i){if(n)return r(n);try{var a=i.objectStore(e._dbInfo.storeName).openKeyCursor(),s=[];a.onsuccess=function(){var e=a.result;e?(s.push(e.key),e.continue()):t(s)},a.onerror=function(){r(a.error)}}catch(o){r(o)}}))})).catch(r)}));return l(r,t),r}function q(t,e){e=d.apply(this,arguments);var r=this.config();(t="function"!==typeof t&&t||{}).name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var n,i=this;if(t.name){var a=t.name===r.name&&i._dbInfo.db?u.resolve(i._dbInfo.db):B(t).then((function(e){var r=g[t.name],n=r.forages;r.db=e;for(var i=0;i<n.length;i++)n[i]._dbInfo.db=e;return e}));n=t.storeName?a.then((function(e){if(e.objectStoreNames.contains(t.storeName)){var r=e.version+1;E(t);var n=g[t.name],i=n.forages;e.close();for(var a=0;a<i.length;a++){var o=i[a];o._dbInfo.db=null,o._dbInfo.version=r}var c=new u((function(e,n){var i=s.open(t.name,r);i.onerror=function(t){i.result.close(),n(t)},i.onupgradeneeded=function(){i.result.deleteObjectStore(t.storeName)},i.onsuccess=function(){var t=i.result;t.close(),e(t)}}));return c.then((function(t){n.db=t;for(var e=0;e<i.length;e++){var r=i[e];r._dbInfo.db=t,C(r._dbInfo)}})).catch((function(e){throw(D(t,e)||u.resolve()).catch((function(){})),e}))}})):a.then((function(e){E(t);var r=g[t.name],n=r.forages;e.close();for(var i=0;i<n.length;i++)n[i]._dbInfo.db=null;var a=new u((function(e,r){var n=s.deleteDatabase(t.name);n.onerror=function(){var t=n.result;t&&t.close(),r(n.error)},n.onblocked=function(){console.warn('dropInstance blocked for database "'+t.name+'" until all open connections are closed')},n.onsuccess=function(){var t=n.result;t&&t.close(),e(t)}}));return a.then((function(t){r.db=t;for(var e=0;e<n.length;e++)C(n[e]._dbInfo)})).catch((function(e){throw(D(t,e)||u.resolve()).catch((function(){})),e}))}))}else n=u.reject("Invalid arguments");return l(n,e),n}var Y={_driver:"asyncStorage",_initStorage:j,_support:o(),iterate:P,getItem:N,setItem:F,removeItem:U,clear:W,length:H,key:G,keys:V,dropInstance:q};function K(){return"function"===typeof openDatabase}var J="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",X="~~local_forage_type~",Q=/^~~local_forage_type~([^~]+)~/,Z="__lfsc__:",$=Z.length,tt="arbf",et="blob",rt="si08",nt="ui08",it="uic8",at="si16",st="si32",ot="ur16",ct="ui32",ut="fl32",lt="fl64",ht=$+tt.length,ft=Object.prototype.toString;function dt(t){var e,r,n,i,a,s=.75*t.length,o=t.length,c=0;"="===t[t.length-1]&&(s--,"="===t[t.length-2]&&s--);var u=new ArrayBuffer(s),l=new Uint8Array(u);for(e=0;e<o;e+=4)r=J.indexOf(t[e]),n=J.indexOf(t[e+1]),i=J.indexOf(t[e+2]),a=J.indexOf(t[e+3]),l[c++]=r<<2|n>>4,l[c++]=(15&n)<<4|i>>2,l[c++]=(3&i)<<6|63&a;return u}function vt(t){var e,r=new Uint8Array(t),n="";for(e=0;e<r.length;e+=3)n+=J[r[e]>>2],n+=J[(3&r[e])<<4|r[e+1]>>4],n+=J[(15&r[e+1])<<2|r[e+2]>>6],n+=J[63&r[e+2]];return r.length%3===2?n=n.substring(0,n.length-1)+"=":r.length%3===1&&(n=n.substring(0,n.length-2)+"=="),n}function pt(t,e){var r="";if(t&&(r=ft.call(t)),t&&("[object ArrayBuffer]"===r||t.buffer&&"[object ArrayBuffer]"===ft.call(t.buffer))){var n,i=Z;t instanceof ArrayBuffer?(n=t,i+=tt):(n=t.buffer,"[object Int8Array]"===r?i+=rt:"[object Uint8Array]"===r?i+=nt:"[object Uint8ClampedArray]"===r?i+=it:"[object Int16Array]"===r?i+=at:"[object Uint16Array]"===r?i+=ot:"[object Int32Array]"===r?i+=st:"[object Uint32Array]"===r?i+=ct:"[object Float32Array]"===r?i+=ut:"[object Float64Array]"===r?i+=lt:e(new Error("Failed to get type for BinaryArray"))),e(i+vt(n))}else if("[object Blob]"===r){var a=new FileReader;a.onload=function(){var r=X+t.type+"~"+vt(this.result);e(Z+et+r)},a.readAsArrayBuffer(t)}else try{e(JSON.stringify(t))}catch(s){console.error("Couldn't convert value into a JSON string: ",t),e(null,s)}}function gt(t){if(t.substring(0,$)!==Z)return JSON.parse(t);var e,r=t.substring(ht),n=t.substring($,ht);if(n===et&&Q.test(r)){var i=r.match(Q);e=i[1],r=r.substring(i[0].length)}var a=dt(r);switch(n){case tt:return a;case et:return c([a],{type:e});case rt:return new Int8Array(a);case nt:return new Uint8Array(a);case it:return new Uint8ClampedArray(a);case at:return new Int16Array(a);case ot:return new Uint16Array(a);case st:return new Int32Array(a);case ct:return new Uint32Array(a);case ut:return new Float32Array(a);case lt:return new Float64Array(a);default:throw new Error("Unkown type: "+n)}}var mt={serialize:pt,deserialize:gt,stringToBuffer:dt,bufferToString:vt};function yt(t,e,r,n){t.executeSql("CREATE TABLE IF NOT EXISTS "+e.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],r,n)}function bt(t){var e=this,r={db:null};if(t)for(var n in t)r[n]="string"!==typeof t[n]?t[n].toString():t[n];var i=new u((function(t,n){try{r.db=openDatabase(r.name,String(r.version),r.description,r.size)}catch(i){return n(i)}r.db.transaction((function(i){yt(i,r,(function(){e._dbInfo=r,t()}),(function(t,e){n(e)}))}),n)}));return r.serializer=mt,i}function kt(t,e,r,n,i,a){t.executeSql(r,n,i,(function(t,s){s.code===s.SYNTAX_ERR?t.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[e.storeName],(function(t,o){o.rows.length?a(t,s):yt(t,e,(function(){t.executeSql(r,n,i,a)}),a)}),a):a(t,s)}),a)}function wt(t,e){var r=this;t=f(t);var n=new u((function(e,n){r.ready().then((function(){var i=r._dbInfo;i.db.transaction((function(r){kt(r,i,"SELECT * FROM "+i.storeName+" WHERE key = ? LIMIT 1",[t],(function(t,r){var n=r.rows.length?r.rows.item(0).value:null;n&&(n=i.serializer.deserialize(n)),e(n)}),(function(t,e){n(e)}))}))})).catch(n)}));return l(n,e),n}function St(t,e){var r=this,n=new u((function(e,n){r.ready().then((function(){var i=r._dbInfo;i.db.transaction((function(r){kt(r,i,"SELECT * FROM "+i.storeName,[],(function(r,n){for(var a=n.rows,s=a.length,o=0;o<s;o++){var c=a.item(o),u=c.value;if(u&&(u=i.serializer.deserialize(u)),void 0!==(u=t(u,c.key,o+1)))return void e(u)}e()}),(function(t,e){n(e)}))}))})).catch(n)}));return l(n,e),n}function Et(t,e,r,n){var i=this;t=f(t);var a=new u((function(a,s){i.ready().then((function(){void 0===e&&(e=null);var o=e,c=i._dbInfo;c.serializer.serialize(e,(function(e,u){u?s(u):c.db.transaction((function(r){kt(r,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[t,e],(function(){a(o)}),(function(t,e){s(e)}))}),(function(e){if(e.code===e.QUOTA_ERR){if(n>0)return void a(Et.apply(i,[t,o,r,n-1]));s(e)}}))}))})).catch(s)}));return l(a,r),a}function Ct(t,e,r){return Et.apply(this,[t,e,r,1])}function Dt(t,e){var r=this;t=f(t);var n=new u((function(e,n){r.ready().then((function(){var i=r._dbInfo;i.db.transaction((function(r){kt(r,i,"DELETE FROM "+i.storeName+" WHERE key = ?",[t],(function(){e()}),(function(t,e){n(e)}))}))})).catch(n)}));return l(n,e),n}function _t(t){var e=this,r=new u((function(t,r){e.ready().then((function(){var n=e._dbInfo;n.db.transaction((function(e){kt(e,n,"DELETE FROM "+n.storeName,[],(function(){t()}),(function(t,e){r(e)}))}))})).catch(r)}));return l(r,t),r}function Bt(t){var e=this,r=new u((function(t,r){e.ready().then((function(){var n=e._dbInfo;n.db.transaction((function(e){kt(e,n,"SELECT COUNT(key) as c FROM "+n.storeName,[],(function(e,r){var n=r.rows.item(0).c;t(n)}),(function(t,e){r(e)}))}))})).catch(r)}));return l(r,t),r}function It(t,e){var r=this,n=new u((function(e,n){r.ready().then((function(){var i=r._dbInfo;i.db.transaction((function(r){kt(r,i,"SELECT key FROM "+i.storeName+" WHERE id = ? LIMIT 1",[t+1],(function(t,r){var n=r.rows.length?r.rows.item(0).key:null;e(n)}),(function(t,e){n(e)}))}))})).catch(n)}));return l(n,e),n}function At(t){var e=this,r=new u((function(t,r){e.ready().then((function(){var n=e._dbInfo;n.db.transaction((function(e){kt(e,n,"SELECT key FROM "+n.storeName,[],(function(e,r){for(var n=[],i=0;i<r.rows.length;i++)n.push(r.rows.item(i).key);t(n)}),(function(t,e){r(e)}))}))})).catch(r)}));return l(r,t),r}function Mt(t){return new u((function(e,r){t.transaction((function(n){n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(r,n){for(var i=[],a=0;a<n.rows.length;a++)i.push(n.rows.item(a).name);e({db:t,storeNames:i})}),(function(t,e){r(e)}))}),(function(t){r(t)}))}))}function Rt(t,e){e=d.apply(this,arguments);var r=this.config();(t="function"!==typeof t&&t||{}).name||(t.name=t.name||r.name,t.storeName=t.storeName||r.storeName);var n,i=this;return l(n=t.name?new u((function(e){var n;n=t.name===r.name?i._dbInfo.db:openDatabase(t.name,"","",0),t.storeName?e({db:n,storeNames:[t.storeName]}):e(Mt(n))})).then((function(t){return new u((function(e,r){t.db.transaction((function(n){function i(t){return new u((function(e,r){n.executeSql("DROP TABLE IF EXISTS "+t,[],(function(){e()}),(function(t,e){r(e)}))}))}for(var a=[],s=0,o=t.storeNames.length;s<o;s++)a.push(i(t.storeNames[s]));u.all(a).then((function(){e()})).catch((function(t){r(t)}))}),(function(t){r(t)}))}))})):u.reject("Invalid arguments"),e),n}var Tt={_driver:"webSQLStorage",_initStorage:bt,_support:K(),iterate:St,getItem:wt,setItem:Ct,removeItem:Dt,clear:_t,length:Bt,key:It,keys:At,dropInstance:Rt};function Lt(){try{return"undefined"!==typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(t){return!1}}function xt(t,e){var r=t.name+"/";return t.storeName!==e.storeName&&(r+=t.storeName+"/"),r}function Ot(){var t="_localforage_support_test";try{return localStorage.setItem(t,!0),localStorage.removeItem(t),!1}catch(e){return!0}}function zt(){return!Ot()||localStorage.length>0}function jt(t){var e=this,r={};if(t)for(var n in t)r[n]=t[n];return r.keyPrefix=xt(t,e._defaultConfig),zt()?(e._dbInfo=r,r.serializer=mt,u.resolve()):u.reject()}function Nt(t){var e=this,r=e.ready().then((function(){for(var t=e._dbInfo.keyPrefix,r=localStorage.length-1;r>=0;r--){var n=localStorage.key(r);0===n.indexOf(t)&&localStorage.removeItem(n)}}));return l(r,t),r}function Pt(t,e){var r=this;t=f(t);var n=r.ready().then((function(){var e=r._dbInfo,n=localStorage.getItem(e.keyPrefix+t);return n&&(n=e.serializer.deserialize(n)),n}));return l(n,e),n}function Ft(t,e){var r=this,n=r.ready().then((function(){for(var e=r._dbInfo,n=e.keyPrefix,i=n.length,a=localStorage.length,s=1,o=0;o<a;o++){var c=localStorage.key(o);if(0===c.indexOf(n)){var u=localStorage.getItem(c);if(u&&(u=e.serializer.deserialize(u)),void 0!==(u=t(u,c.substring(i),s++)))return u}}}));return l(n,e),n}function Ut(t,e){var r=this,n=r.ready().then((function(){var e,n=r._dbInfo;try{e=localStorage.key(t)}catch(i){e=null}return e&&(e=e.substring(n.keyPrefix.length)),e}));return l(n,e),n}function Wt(t){var e=this,r=e.ready().then((function(){for(var t=e._dbInfo,r=localStorage.length,n=[],i=0;i<r;i++){var a=localStorage.key(i);0===a.indexOf(t.keyPrefix)&&n.push(a.substring(t.keyPrefix.length))}return n}));return l(r,t),r}function Ht(t){var e=this.keys().then((function(t){return t.length}));return l(e,t),e}function Gt(t,e){var r=this;t=f(t);var n=r.ready().then((function(){var e=r._dbInfo;localStorage.removeItem(e.keyPrefix+t)}));return l(n,e),n}function Vt(t,e,r){var n=this;t=f(t);var i=n.ready().then((function(){void 0===e&&(e=null);var r=e;return new u((function(i,a){var s=n._dbInfo;s.serializer.serialize(e,(function(e,n){if(n)a(n);else try{localStorage.setItem(s.keyPrefix+t,e),i(r)}catch(o){"QuotaExceededError"!==o.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==o.name||a(o),a(o)}}))}))}));return l(i,r),i}function qt(t,e){if(e=d.apply(this,arguments),!(t="function"!==typeof t&&t||{}).name){var r=this.config();t.name=t.name||r.name,t.storeName=t.storeName||r.storeName}var n,i=this;return n=t.name?new u((function(e){t.storeName?e(xt(t,i._defaultConfig)):e(t.name+"/")})).then((function(t){for(var e=localStorage.length-1;e>=0;e--){var r=localStorage.key(e);0===r.indexOf(t)&&localStorage.removeItem(r)}})):u.reject("Invalid arguments"),l(n,e),n}var Yt={_driver:"localStorageWrapper",_initStorage:jt,_support:Lt(),iterate:Ft,getItem:Pt,setItem:Vt,removeItem:Gt,clear:Nt,length:Ht,key:Ut,keys:Wt,dropInstance:qt},Kt=function(t,e){return t===e||"number"===typeof t&&"number"===typeof e&&isNaN(t)&&isNaN(e)},Jt=function(t,e){for(var r=t.length,n=0;n<r;){if(Kt(t[n],e))return!0;n++}return!1},Xt=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},Qt={},Zt={},$t={INDEXEDDB:Y,WEBSQL:Tt,LOCALSTORAGE:Yt},te=[$t.INDEXEDDB._driver,$t.WEBSQL._driver,$t.LOCALSTORAGE._driver],ee=["dropInstance"],re=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ee),ne={description:"",driver:te.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function ie(t,e){t[e]=function(){var r=arguments;return t.ready().then((function(){return t[e].apply(t,r)}))}}function ae(){for(var t=1;t<arguments.length;t++){var e=arguments[t];if(e)for(var r in e)e.hasOwnProperty(r)&&(Xt(e[r])?arguments[0][r]=e[r].slice():arguments[0][r]=e[r])}return arguments[0]}var se=function(){function t(e){for(var r in i(this,t),$t)if($t.hasOwnProperty(r)){var n=$t[r],a=n._driver;this[r]=a,Qt[a]||this.defineDriver(n)}this._defaultConfig=ae({},ne),this._config=ae({},this._defaultConfig,e),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return t.prototype.config=function(t){if("object"===("undefined"===typeof t?"undefined":n(t))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var e in t){if("storeName"===e&&(t[e]=t[e].replace(/\W/g,"_")),"version"===e&&"number"!==typeof t[e])return new Error("Database version must be a number.");this._config[e]=t[e]}return!("driver"in t)||!t.driver||this.setDriver(this._config.driver)}return"string"===typeof t?this._config[t]:this._config},t.prototype.defineDriver=function(t,e,r){var n=new u((function(e,r){try{var n=t._driver,i=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver)return void r(i);for(var a=re.concat("_initStorage"),s=0,o=a.length;s<o;s++){var c=a[s];if((!Jt(ee,c)||t[c])&&"function"!==typeof t[c])return void r(i)}var h=function(){for(var e=function(t){return function(){var e=new Error("Method "+t+" is not implemented by the current driver"),r=u.reject(e);return l(r,arguments[arguments.length-1]),r}},r=0,n=ee.length;r<n;r++){var i=ee[r];t[i]||(t[i]=e(i))}};h();var f=function(r){Qt[n]&&console.info("Redefining LocalForage driver: "+n),Qt[n]=t,Zt[n]=r,e()};"_support"in t?t._support&&"function"===typeof t._support?t._support().then(f,r):f(!!t._support):f(!0)}catch(d){r(d)}}));return h(n,e,r),n},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(t,e,r){var n=Qt[t]?u.resolve(Qt[t]):u.reject(new Error("Driver not found."));return h(n,e,r),n},t.prototype.getSerializer=function(t){var e=u.resolve(mt);return h(e,t),e},t.prototype.ready=function(t){var e=this,r=e._driverSet.then((function(){return null===e._ready&&(e._ready=e._initDriver()),e._ready}));return h(r,t,t),r},t.prototype.setDriver=function(t,e,r){var n=this;Xt(t)||(t=[t]);var i=this._getSupportedDrivers(t);function a(){n._config.driver=n.driver()}function s(t){return n._extend(t),a(),n._ready=n._initStorage(n._config),n._ready}function o(t){return function(){var e=0;function r(){for(;e<t.length;){var i=t[e];return e++,n._dbInfo=null,n._ready=null,n.getDriver(i).then(s).catch(r)}a();var o=new Error("No available storage method found.");return n._driverSet=u.reject(o),n._driverSet}return r()}}var c=null!==this._driverSet?this._driverSet.catch((function(){return u.resolve()})):u.resolve();return this._driverSet=c.then((function(){var t=i[0];return n._dbInfo=null,n._ready=null,n.getDriver(t).then((function(t){n._driver=t._driver,a(),n._wrapLibraryMethodsWithReady(),n._initDriver=o(i)}))})).catch((function(){a();var t=new Error("No available storage method found.");return n._driverSet=u.reject(t),n._driverSet})),h(this._driverSet,e,r),this._driverSet},t.prototype.supports=function(t){return!!Zt[t]},t.prototype._extend=function(t){ae(this,t)},t.prototype._getSupportedDrivers=function(t){for(var e=[],r=0,n=t.length;r<n;r++){var i=t[r];this.supports(i)&&e.push(i)}return e},t.prototype._wrapLibraryMethodsWithReady=function(){for(var t=0,e=re.length;t<e;t++)ie(this,re[t])},t.prototype.createInstance=function(e){return new t(e)},t}(),oe=new se;e.exports=oe},{3:3}]},{},[4])(4)}},e={};function r(n){var i=e[n];if(void 0!==i)return i.exports;var a=e[n]={exports:{}};return t[n](a,a.exports,r),a.exports}r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,{a:e}),e},r.d=function(t,e){for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}(),r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},function(){"use strict";function t(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function e(e,r){if(e){if("string"===typeof e)return t(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?t(e,r):void 0}}function n(t,r){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,a,s,o=[],c=!0,u=!1;try{if(a=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=a.call(r)).done)&&(o.push(n.value),o.length!==e);c=!0);}catch(l){u=!0,i=l}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw i}}return o}}(t,r)||e(t,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function a(){a=function(){return t};var t={},e=Object.prototype,r=e.hasOwnProperty,n=Object.defineProperty||function(t,e,r){t[e]=r.value},s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",c=s.asyncIterator||"@@asyncIterator",u=s.toStringTag||"@@toStringTag";function l(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(M){l=function(t,e,r){return t[e]=r}}function h(t,e,r,i){var a=e&&e.prototype instanceof v?e:v,s=Object.create(a.prototype),o=new B(i||[]);return n(s,"_invoke",{value:E(t,r,o)}),s}function f(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(M){return{type:"throw",arg:M}}}t.wrap=h;var d={};function v(){}function p(){}function g(){}var m={};l(m,o,(function(){return this}));var y=Object.getPrototypeOf,b=y&&y(y(I([])));b&&b!==e&&r.call(b,o)&&(m=b);var k=g.prototype=v.prototype=Object.create(m);function w(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function S(t,e){function a(n,s,o,c){var u=f(t[n],t,s);if("throw"!==u.type){var l=u.arg,h=l.value;return h&&"object"==i(h)&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){a("next",t,o,c)}),(function(t){a("throw",t,o,c)})):e.resolve(h).then((function(t){l.value=t,o(l)}),(function(t){return a("throw",t,o,c)}))}c(u.arg)}var s;n(this,"_invoke",{value:function(t,r){function n(){return new e((function(e,n){a(t,r,e,n)}))}return s=s?s.then(n,n):n()}})}function E(t,e,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return A()}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var o=C(s,r);if(o){if(o===d)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=f(t,e,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===d)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function C(t,e){var r=e.method,n=t.iterator[r];if(void 0===n)return e.delegate=null,"throw"===r&&t.iterator.return&&(e.method="return",e.arg=void 0,C(t,e),"throw"===e.method)||"return"!==r&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var i=f(n,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,d;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,d):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,d)}function D(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function _(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(D,this),this.reset(!0)}function I(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:A}}function A(){return{value:void 0,done:!0}}return p.prototype=g,n(k,"constructor",{value:g,configurable:!0}),n(g,"constructor",{value:p,configurable:!0}),p.displayName=l(g,u,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===p||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,g):(t.__proto__=g,l(t,u,"GeneratorFunction")),t.prototype=Object.create(k),t},t.awrap=function(t){return{__await:t}},w(S.prototype),l(S.prototype,c,(function(){return this})),t.AsyncIterator=S,t.async=function(e,r,n,i,a){void 0===a&&(a=Promise);var s=new S(h(e,r,n,i),a);return t.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},w(k),l(k,u,"Generator"),l(k,o,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},t.values=I,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return s.type="throw",s.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var o=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(o&&c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=t,s.arg=e,a?(this.method="next",this.next=a.finallyLoc,d):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),d},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),_(r),d}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;_(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:I(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),d}},t}function s(t,e,r,n,i,a,s){try{var o=t[a](s),c=o.value}catch(u){return void r(u)}o.done?e(c):Promise.resolve(c).then(n,i)}function o(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function o(t){s(a,n,i,o,c,"next",t)}function c(t){s(a,n,i,o,c,"throw",t)}o(void 0)}))}}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t){var e=function(t,e){if("object"!==i(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!==i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===i(e)?e:String(e)}function l(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,u(n.key),n)}}function h(t,e,r){return e&&l(t.prototype,e),r&&l(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function f(t){for(var e=[],r=0;r<t.length;r+=1){var n=t[r];n>15?e.push(n.toString(16)):e.push("0"+n.toString(16))}return e.join("")}function d(t,e){for(var r=0;r<t.length;r+=1){var n=2*r,i=parseInt(t.slice(n,n+2),16);e[r]=i}}function v(t,e){return{read:function(){return t[e]},write:function(r,n){t[e]=n}}}var p=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8192,r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;c(this,t),this.bytes=void 0,this.size=void 0,this.isLocked=void 0,this.getOffset=void 0,this.bytes=new Uint8Array(e),this.size=e,this.getOffset=n,this.isLocked=r}return h(t,[{key:"serialize",value:function(){return f(this.bytes)}},{key:"deserialize",value:function(t){d(t,this.bytes)}},{key:"read",value:function(t){return this.isLocked()||t>this.size?255:this.bytes[(t+this.getOffset(t))%this.size]}},{key:"write",value:function(t,e){this.isLocked()||(this.bytes[(t+this.getOffset(t))%this.size]=e)}},{key:"reset",value:function(){this.bytes.fill(0)}}]),t}();function g(t){return g=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},g(t)}function m(){return m="undefined"!==typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=g(t)););return t}(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(arguments.length<3?t:r):i.value}},m.apply(this,arguments)}function y(t,e){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},y(t,e)}function b(t,e){if(e&&("object"===i(e)||"function"===typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function k(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=g(t);if(e){var i=g(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return b(this,r)}}var w=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8192;c(this,t),this.bytes=void 0,this.size=void 0,this.bytes=new Uint8Array(e),this.size=e}return h(t,[{key:"serialize",value:function(){return f(this.bytes)}},{key:"deserialize",value:function(t){d(t,this.bytes)}},{key:"read",value:function(t){return t>this.size?255:this.bytes[t%this.size]}},{key:"write",value:function(t,e){this.bytes[t%this.size]=e}},{key:"reset",value:function(){this.bytes.fill(0)}}]),t}(),S=function(t){!function(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&y(t,e)}(r,t);var e=k(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8192,i=arguments.length>1?arguments[1]:void 0;return c(this,r),(t=e.call(this,n)).isLocked=void 0,t.isLocked=i,t}return h(r,[{key:"read",value:function(t){return this.isLocked()?255:m(g(r.prototype),"read",this).call(this,t)}},{key:"write",value:function(t,e){if(!this.isLocked())return m(g(r.prototype),"write",this).call(this,t,e)}}]),r}(w),E=0,C=1,D=2,_=3,B=4,I=5,A=6,M=7,R=8,T=9,L=4,x=6,O=5,z=7;function j(t){return"$"+t.toString(16).padStart(4,"0")}function N(t){return"$"+t.toString(16).padStart(2,"0")}var P,F,U=0,W=1,H=2,G=4,V=["V-blank","LCDC","Timer overflow","Serial complete","Pin triggered"],q=65535,Y=65295,K=function(){function t(e){c(this,t),this.cpu=void 0,this.interruptsEnable=void 0,this.interruptsFlag=void 0,this.cpu=e,this.interruptsEnable=0,this.interruptsFlag=0}return h(t,[{key:"reset",value:function(){this.interruptsEnable=0,this.interruptsFlag=0}},{key:"serialize",value:function(){return{ie:this.interruptsEnable,if:this.interruptsFlag}}},{key:"deserialize",value:function(t){this.interruptsEnable=t.ie,this.interruptsFlag=t.if}},{key:"register",value:function(t){var e=this,r=t.ioBus;r.register(15,"IF",{read:function(){return e.interruptsFlag},write:function(t,r){e.interruptsFlag=r}}),r.register(255,"IE",{read:function(){return e.interruptsEnable},write:function(t,r){e.interruptsEnable=r}})}},{key:"queueInterrupt",value:function(t){var e=this.cpu.memory,r=e.read(Y);r|=1<<t,e.write(Y,r)}},{key:"acceptsInterrupt",value:function(){return 0!==(31&this.cpu.memory.read(q))}},{key:"getDebugState",value:function(){var t=this.cpu.memory,e=t.read(Y),r=t.read(q);return["IME: ".concat(this.cpu.isInterruptsEnabled),"IF: ".concat(e.toString(16)," IE: ").concat(r.toString(16))].join("\n")}},{key:"step",value:function(){if(this.cpu.isInterruptsEnabled||!this.cpu.isRunning){var t=this.cpu.memory,e=t.read(Y),r=t.read(q)&e;if(r){for(var n=0;0===(1&r);)n+=1,r>>>=1;if(this.cpu.isRunning=!0,this.cpu.isInterruptsEnabled){t.write(Y,e&~(1<<n));var i=this.cpu.registers[R];this.cpu.enterInterrupt();var a=64+8*n;this.cpu.jump(a),this.cpu.isDebugging&&this.cpu.log("event","Interrupt ".concat(n," (").concat(V[n],")"),void 0,"pc=".concat(j(a)," (was ").concat(j(i),") sp=").concat(j(this.cpu.registers[T])))}else this.cpu.isDebugging&&this.cpu.log("event","Interrupt resume ".concat(n," (").concat(V[n],")"))}}this.cpu.isRunning&&this.cpu.step()}}]),t}();function J(t,e,r){return(e=u(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}!function(t){t[t.DMG=0]="DMG",t[t.CGB=1]="CGB",t[t.SGB=2]="SGB"}(F||(F={}));var X=(J(P={},F.DMG,[1,0,19,0,216,176,1,77,0,65534]),J(P,F.CGB,[17,0,19,0,216,176,1,77,0,65534]),J(P,F.SGB,[1,0,19,0,216,176,1,77,0,65534]),P);function Q(t,e){var r=8192*(arguments.length>2&&void 0!==arguments[2]?arguments[2]:0);return 0===(t.lcdc&st.BG_WINDOW_TILE_DATA_SELECT)?e>=128?r+2048+16*(e-128):r+4096+16*e:r+16*e}function Z(t,e,r){var n=t.lcdc&st.BG_TILE_MAP_DISPLAY_SELECT?7168:6144;return t.vram.bytes[n+32*r+e]}function $(t,e,r){var n=t.lcdc&st.BG_TILE_MAP_DISPLAY_SELECT?15360:14336;return t.vram.bytes[n+32*r+e]}function tt(t,e,r){var n=t.lcdc&st.WINDOW_TILE_MAP_DISPLAY_SELECT?7168:6144;return t.vram.bytes[n+32*r+e]}function et(t,e,r){var n=t.lcdc&st.WINDOW_TILE_MAP_DISPLAY_SELECT?15360:14336;return t.vram.bytes[n+32*r+e]}function rt(t,e,r){var n=8*e+2*r;return t.bgPalette[n]|t.bgPalette[n+1]<<8}function nt(t,e,r){var n=8*e+2*r;return t.objPalette[n]|t.objPalette[n+1]<<8}var it={PALETTE:16,X_FLIP:32,Y_FLIP:64,BG_WINDOW_OVER_OBJ:128};function at(t,e){e>=lt||(function(t,e){var r=t.isCGB,n=0===(t.lcdc&st.BG_WINDOW_DISPLAY);if(r||!n){var i=t.vram.bytes,a=e+t.scy,s=a/8&31,o=a%8,c=e*ut,u=0;do{for(var l=u+t.scx,h=l/8&31,f=7-l%8,d=Z(t,h,s),v=$(t,h,s),p=7&v,g=0!==(32&v),m=0!==(128&v),y=0!==(64&v)?7-o:o,b=Q(t,d,v>>>3&1),k=i[b+2*y],w=i[b+2*y+1];f>=0;){var S=g?7-f:f,E=k>>S&1|(w>>S&1)<<1;if(r){var C=rt(t,p,E);t.framebuffer[c+u]=C,t.lineData[u]=(m?2:0)|(E>0?1:0)}else{var D=t.bgp>>(E<<1)&3;t.framebuffer[c+u]=32768|D,t.lineData[u]=E>0?1:0}f-=1,u+=1}}while(u<ut)}}(t,e),function(t,e){var r=t.isCGB;if((r||0!==(t.lcdc&st.BG_WINDOW_DISPLAY))&&0!==(t.lcdc&st.WINDOW_DISPLAY)){var n=t.vram.bytes,i=e-t.wy;if(!(i<0)){var a=i/8&31,s=i%8,o=e*ut,c=Math.max(0,t.wx-7);do{for(var u=c-(t.wx-7),l=u/8&31,h=7-u%8,f=tt(t,l,a),d=et(t,l,a),v=7&d,p=0!==(32&d),g=0!==(128&d),m=0!==(64&d)?7-s:s,y=Q(t,f,d>>>3&1),b=n[y+2*m],k=n[y+2*m+1];h>=0;){var w=p?7-h:h,S=b>>w&1|(k>>w&1)<<1;if(r){var E=rt(t,v,S);t.framebuffer[o+c]=E,t.lineData[c]=(g?2:0)|(S>0?1:0)}else{var C=t.bgp>>(S<<1)&3;t.framebuffer[o+c]=32768|C,t.lineData[c]=S>0?1:0}h-=1,c+=1}}while(c<ut)}}}(t,e),function(t,e){if(0!==(t.lcdc&st.OBJ_DISPLAY)){for(var r=0!==(t.lcdc&st.BG_WINDOW_DISPLAY),n=t.isCGB,i=t.oam.bytes,a=t.vram.bytes,s=t.lcdc&st.OBJ_SIZE?16:8,o=e*ut,c=[],u=0;u<160;u+=4){var l=e-(i[u]-16);if(!(l<0||l>=s)){var h=i[u+1]-8;h<=-8||h>ut||c.push(u)}}for(var f=c.length-1;f>=0;f-=1){var d=c[f],v=e-(i[d]-16);if(!(v<0||v>=s)){var p=i[d+1]-8,g=i[d+2],m=i[d+3],y=m&it.PALETTE?t.obp1:t.obp0,b=0!==(m&it.X_FLIP),k=0!==(m&it.Y_FLIP),w=0!==(m&it.BG_WINDOW_OVER_OBJ),S=7&m,E=m>>>3&1;k&&(v=s-1-v),16===s&&(g&=254);for(var C=a[8192*E+16*g+2*v],D=a[8192*E+16*g+2*v+1],_=0;_<8;_+=1){var B=b?_:7-_,I=p+_;if(!(I<0||I>=ut)){var A=C>>B&1|(D>>B&1)<<1;if(0!==A){var M=t.lineData[I],R=0!==(1&M);if(n){if(R&&r&&(w||0!==(2&M)))continue;var T=nt(t,S,A);t.framebuffer[o+I]=T}else{if(R&&w)continue;var L=y>>(A<<1)&3;t.framebuffer[o+I]=32768|L}}}}}}}}(t,e))}var st={BG_WINDOW_DISPLAY:1,OBJ_DISPLAY:2,OBJ_SIZE:4,BG_TILE_MAP_DISPLAY_SELECT:8,BG_WINDOW_TILE_DATA_SELECT:16,WINDOW_DISPLAY:32,WINDOW_TILE_MAP_DISPLAY_SELECT:64,ENABLED:128},ot=144,ct=248,ut=160,lt=144,ht=["lcdc","stat","scy","scx","ly","lyc","bgp","obp0","obp1","wy","wx","lineClock","clocks","mode","vramBank","bcps","ocps"],ft=function(){function t(e){c(this,t),this.emulator=null,this.interrupter=void 0,this.lcdc=0,this.stat=0,this.scy=0,this.scx=0,this.ly=0,this.lyc=0,this.bgp=0,this.obp0=0,this.obp1=0,this.wy=0,this.wx=0,this.lineClock=0,this.clocks=0,this.mode=0,this.framebuffer=void 0,this.lineData=void 0,this.vram=void 0,this.oam=void 0,this.isCGB=!1,this.vramBank=0,this.bcps=0,this.ocps=0,this.bgPalette=void 0,this.objPalette=void 0,this.setInterrupter(e),this.reset()}return h(t,[{key:"serialize",value:function(){var t=this,e={};return ht.forEach((function(r){return e[r]=t[r]})),e.vram=this.vram.serialize(),e.oam=this.oam.serialize(),e.bgPalette=f(this.bgPalette),e.objPalette=f(this.objPalette),e}},{key:"deserialize",value:function(t){var e=this;ht.forEach((function(r){return e[r]=t[r]})),this.vram.deserialize(t.vram),this.oam.deserialize(t.oam),d(t.bgPalette,this.bgPalette),d(t.objPalette,this.objPalette)}},{key:"getDebugState",value:function(){return["LCDC: ".concat(this.lcdc.toString(16).padStart(2,"0")," STAT: ").concat(this.stat.toString(16).padStart(2,"0")),"LY: ".concat(this.ly.toString(16).padStart(2,"0")," LYC: ").concat(this.lyc.toString(16).padStart(2,"0")),"LCLK: ".concat(this.lineClock," CLK: ").concat(this.clocks," VBK: ").concat(this.vramBank)].join("\n")}},{key:"setInterrupter",value:function(t){this.interrupter=t}},{key:"register",value:function(t,e){var r=this,n=t.ioBus,i=t.memoryBus;this.emulator=e,this.isCGB=t.type===F.CGB,i.register(128,159,this.vram),i.register(254,254,this.oam),n.register(64,"LCDC",{read:function(){return r.lcdc},write:function(t,e){(128&r.lcdc)!==(128&e)&&(r.ly=0,r.mode=0,r.lineClock=0,r.clocks=0),r.lcdc=e}}),n.register(65,"STAT",{read:function(){var t=248&r.stat;return t|=r.mode,r.ly===r.lyc&&(t|=4),t},write:function(t,e){r.stat=e}}),n.register(66,"SCY",v(this,"scy")),n.register(67,"SCX",v(this,"scx")),n.register(68,"LY",v(this,"ly")),n.register(69,"LYC",v(this,"lyc")),n.register(71,"BGP",v(this,"bgp")),n.register(72,"OBP0",v(this,"obp0")),n.register(73,"OBP1",v(this,"obp1")),n.register(74,"WY",v(this,"wy")),n.register(75,"WX",v(this,"wx")),t.type===F.CGB&&(n.register(79,"VBK",{read:function(){return 254|r.vramBank},write:function(t,e){r.vramBank=1&e}}),n.register(104,"BCPS",v(this,"bcps")),n.register(105,"BCPD",{read:function(){var t=63&r.bcps;return r.bgPalette[t]},write:function(t,e){var n=63&r.bcps;0!==(128&r.bcps)&&(r.bcps=r.bcps+1&63|128&r.bcps),r.bgPalette[n]=e}}),n.register(106,"OCPS",v(this,"ocps")),n.register(107,"OCPD",{read:function(){var t=63&r.ocps;return r.objPalette[t]},write:function(t,e){var n=63&r.ocps;0!==(128&r.ocps)&&(r.ocps=r.ocps+1&63|128&r.ocps),r.objPalette[n]=e}}))}},{key:"reset",value:function(){var t=this;this.lcdc=145,this.stat=0,this.scy=0,this.scx=0,this.ly=0,this.lyc=0,this.bgp=252,this.obp0=255,this.obp1=255,this.wy=0,this.wx=0,this.lineClock=0,this.clocks=0,this.mode=0,this.framebuffer=new Uint16Array(ut*lt),this.lineData=new Uint8Array(ut),this.vram=new p(16384,(function(){return!1}),(function(){return 8192*t.vramBank})),this.oam=new S(256,(function(){return!1})),this.vramBank=0,this.bcps=0,this.ocps=0,this.bgPalette=new Uint8Array(64),this.objPalette=new Uint8Array(64)}},{key:"handleLineChange",value:function(){this.lineClock=0,this.ly>153&&(this.ly=0),this.ly===this.lyc&&64&this.stat&&this.interrupter.queueInterrupt(W),this.ly<ot?(this.mode=2,32&this.stat&&this.interrupter.queueInterrupt(W)):this.ly===ot&&(this.clocks=0,this.mode=1,16&this.stat&&this.interrupter.queueInterrupt(W),this.interrupter.queueInterrupt(U))}},{key:"handleMode3Enter",value:function(){this.mode=3}},{key:"handleMode0Enter",value:function(){this.mode=0,at(this,this.ly),8&this.stat&&this.interrupter.queueInterrupt(W),this.emulator.hdma.enterHBlank()}},{key:"resetClock",value:function(){this.ly=ot,this.lineClock=0,this.clocks=0,this.handleLineChange()}},{key:"getNextWakeupClockAdvance",value:function(){return this.ly>=ot?(456-this.lineClock)/4:this.lineClock<80?(80-this.lineClock)/4:this.lineClock<ct?(ct-this.lineClock)/4:(456-this.lineClock)/4}},{key:"getRemainingClockUntilVblank",value:function(){return 0===(128&this.lcdc)?17556:17556-this.clocks+1}},{key:"advanceClock",value:function(){0!==(128&this.lcdc)&&(this.lineClock+=4,this.ly>=ot?this.lineClock>=456&&(this.ly+=1,this.handleLineChange()):80===this.lineClock?this.handleMode3Enter():this.lineClock===ct?this.handleMode0Enter():456===this.lineClock&&(this.ly+=1,this.handleLineChange()),this.clocks+=1)}}]),t}(),dt=[4294967295,2863311615,1431655935,255];function vt(t,e){return 0===(t.lcdc&st.BG_WINDOW_TILE_DATA_SELECT)?e>=128?2048+16*(e-128):4096+16*e:16*e}function pt(t,e,r){var n=t.lcdc&st.BG_TILE_MAP_DISPLAY_SELECT?7168:6144;return t.vram.bytes[n+32*r+e]}function gt(t,e,r){var n=t.lcdc&st.WINDOW_TILE_MAP_DISPLAY_SELECT?7168:6144;return t.vram.bytes[n+32*r+e]}function mt(t){var e=document.getElementById("dump-canvas");null==e&&((e=document.createElement("canvas")).id="dump-canvas",document.body.appendChild(e));var r=e;r.width=128,r.height=192;for(var n=new Uint8ClampedArray(98304),i=t.vram.bytes,a=0;a<384;a+=1)for(var s=a%16*8,o=8*Math.floor(a/16),c=0;c<8;c+=1)for(var u=i[16*a+2*c],l=i[16*a+2*c+1],h=0;h<8;h+=1){var f=7-h,d=dt[u>>f&1|(l>>f&1)<<1],v=s+h,p=o+c;n[4*(128*p+v)]=d>>>24&255,n[4*(128*p+v)+1]=d>>>16&255,n[4*(128*p+v)+2]=d>>>8&255,n[4*(128*p+v)+3]=255&d}var g=r.getContext("2d"),m=new ImageData(n,128,192);null===g||void 0===g||g.putImageData(m,0,0);var y=document.getElementById("dump-canvas-2");null==y&&((y=document.createElement("canvas")).id="dump-canvas-2",document.body.appendChild(y));var b=y;b.width=512,b.height=256;var k=new Uint8ClampedArray(524288);!function(t,e){for(var r=0;r<256;r+=1){var n=t.vram.bytes,i=r/8&31,a=r%8,s=0;do{for(var o=7-s%8,c=vt(t,pt(t,s/8&31,i)),u=n[c+2*a],l=n[c+2*a+1];o>=0;){var h=u>>o&1|(l>>o&1)<<1,f=t.bgp>>(h<<1)&3,d=dt[f],v=s,p=r;e[4*(512*p+v)]=d>>>24&255,e[4*(512*p+v)+1]=d>>>16&255,e[4*(512*p+v)+2]=d>>>8&255,e[4*(512*p+v)+3]=255&d,o-=1,s+=1}}while(s<256)}for(var g=0;g<256;g+=1){var m=t.vram.bytes,y=g/8&31,b=g%8,k=0;do{for(var w=7-k%8,S=vt(t,gt(t,k/8&31,y)),E=m[S+2*b],C=m[S+2*b+1];w>=0;){var D=E>>w&1|(C>>w&1)<<1,_=t.bgp>>(D<<1)&3,B=dt[_],I=k+256,A=g;e[4*(512*A+I)]=B>>>24&255,e[4*(512*A+I)+1]=B>>>16&255,e[4*(512*A+I)+2]=B>>>8&255,e[4*(512*A+I)+3]=255&B,w-=1,k+=1}}while(k<256)}}(t,k);var w=b.getContext("2d"),S=new ImageData(k,512,256);null===w||void 0===w||w.putImageData(S,0,0);var E=document.getElementById("dump-text");null==E&&((E=document.createElement("div")).id="dump-text",E.style.fontFamily="monospace",document.body.appendChild(E));for(var C=t.oam.bytes,D=[],_=0;_<160;_+=4){var B=C[_]-16,I=C[_+1]-8,A=C[_+2],M=C[_+3];D.push("".concat(I.toString(16).padStart(2,"0")," ").concat(B.toString(16).padStart(2,"0")," ").concat(A.toString(16).padStart(2,"0")," ").concat(M.toString(16).padStart(2,"0")))}E.innerText=D.join("\n")}var yt,bt,kt=[4294967295,2863311615,1431655935,255];function wt(t){return{mbcType:t,hasRAM:arguments.length>1&&void 0!==arguments[1]&&arguments[1],hasBattery:arguments.length>2&&void 0!==arguments[2]&&arguments[2],hasTimer:arguments.length>3&&void 0!==arguments[3]&&arguments[3],hasRumble:arguments.length>4&&void 0!==arguments[4]&&arguments[4],hasSensor:arguments.length>5&&void 0!==arguments[5]&&arguments[5]}}!function(t){t[t.ROM=0]="ROM",t[t.MBC1=1]="MBC1",t[t.MBC2=2]="MBC2",t[t.MMM01=3]="MMM01",t[t.MBC3=4]="MBC3",t[t.MBC5=5]="MBC5",t[t.MBC6=6]="MBC6",t[t.MBC7=7]="MBC7",t[t.POCKET_CAMERA=8]="POCKET_CAMERA",t[t.BANDAI_TAMA5=9]="BANDAI_TAMA5",t[t.HUC3=10]="HUC3",t[t.HUC1=11]="HUC1"}(yt||(yt={}));var St=(J(bt={},0,wt(yt.ROM)),J(bt,1,wt(yt.MBC1)),J(bt,2,wt(yt.MBC1,!0)),J(bt,3,wt(yt.MBC1,!0,!0)),J(bt,5,wt(yt.MBC2,!0)),J(bt,6,wt(yt.MBC2,!0,!0)),J(bt,8,wt(yt.ROM,!0)),J(bt,9,wt(yt.ROM,!0,!0)),J(bt,11,wt(yt.MMM01)),J(bt,12,wt(yt.MMM01,!0)),J(bt,13,wt(yt.MMM01,!0,!0)),J(bt,15,wt(yt.MBC3,!1,!0,!0)),J(bt,16,wt(yt.MBC3,!0,!0,!0)),J(bt,17,wt(yt.MBC3)),J(bt,18,wt(yt.MBC3,!0)),J(bt,19,wt(yt.MBC3,!0,!0)),J(bt,25,wt(yt.MBC5)),J(bt,26,wt(yt.MBC5,!0)),J(bt,27,wt(yt.MBC5,!0,!0)),J(bt,28,wt(yt.MBC5,!1,!1,!1,!0)),J(bt,29,wt(yt.MBC5,!0,!1,!1,!0)),J(bt,30,wt(yt.MBC5,!0,!0,!1,!0)),J(bt,32,wt(yt.MBC6)),J(bt,34,wt(yt.MBC7,!0,!0,!1,!0,!0)),J(bt,252,wt(yt.POCKET_CAMERA)),J(bt,253,wt(yt.BANDAI_TAMA5)),J(bt,254,wt(yt.HUC3)),J(bt,255,wt(yt.HUC1,!0,!0)),bt),Et=[0,0,1,4,16,8];function Ct(t){return Dt.apply(this,arguments)}function Dt(){return(Dt=o(a().mark((function t(e){var r,n,i,s,o,c,u,l,h,f,d,v,p,g,m,y;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=[],n=0;case 2:if(!(n<16)){t.next=10;break}if(!(0===(i=e[308+n])||i>=128)){t.next=6;break}return t.abrupt("break",10);case 6:r.push(String.fromCharCode(i));case 7:n+=1,t.next=2;break;case 10:if(s=r.join(""),o=e[323],c=0!==(128&o),u=0!==(64&o),l=3===e[326],null!=(h=St[e[327]])){t.next=18;break}throw new Error("Unknown cartridge type ".concat(e[327].toString(16)));case 18:return f=2<<e[328],d=16384*f,v=Et[e[329]],p=8192*v,h.mbcType===yt.MBC2&&(v=1,p=4096),t.next=25,crypto.subtle.digest("SHA-1",e);case 25:return g=t.sent,m=new Uint8Array(g),y=Array.from(m).map((function(t){return t.toString(16).padStart(2,"0")})).join(""),t.abrupt("return",{title:s,supportsCGB:c,requiresCGB:u,supportsSGB:l,cartridgeType:h,romBanks:f,romSize:d,ramBanks:v,ramSize:p,sha1Sum:y});case 29:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var _t=function(){function t(e,r){c(this,t),this.rom=void 0,this.ram=void 0,this.bank=1,this.ramEnabled=!0,this.ramUpdated=!1,this.bankingMode=!1,this.rom=e,this.ram=r}return h(t,[{key:"loadRAM",value:function(t){this.ram=t}},{key:"serializeRAM",value:function(){return this.ram}},{key:"serialize",value:function(){var t={};return t.ram=null!=this.ram?f(this.ram):null,t.bank=this.bank,t.ramEnabled=this.ramEnabled,t.ramUpdated=this.ramUpdated,t.bankingMode=this.bankingMode,t}},{key:"deserialize",value:function(t){null!=this.ram&&d(t.ram,this.ram),this.bank=t.bank,this.ramEnabled=t.ramEnabled,this.ramUpdated=t.ramUpdated,this.bankingMode=t.bankingMode}},{key:"getDebugState",value:function(){return["Bank: ".concat(this.bank.toString(16).padStart(2,"0")," Mode: ").concat(this.bankingMode)].join("\n")}},{key:"read",value:function(t){if(t<16384){var e=this.bankingMode?96&this.bank:0;return this.rom[(16384*e+t)%this.rom.length]}if(t<32768)return this.rom[(16384*this.bank+(t-16384))%this.rom.length];if(t<40960)return 0;if(t<49152){if(null==this.ram)return 255;var r=this.bankingMode?this.bank>>4&3:0;return this.ram[(8192*r+(t-40960))%this.ram.length]}return 0}},{key:"write",value:function(t,e){if(t<8192)this.ramEnabled=0!==(10&e);else{if(t<16384)return this.bank=-32&this.bank|31&e,void(0===this.bank&&(this.bank=1));if(t<24576)this.bank=-97&this.bank|e<<4&96;else if(t<32768)this.bankingMode=0!==e;else if(!(t<40960)&&t<49152){if(null==this.ram)return;var r=this.bankingMode?this.bank>>4&3:0;this.ram[(8192*r+(t-40960))%this.ram.length]=e,this.ramUpdated=!0}}}},{key:"reset",value:function(){this.bank=1,this.bankingMode=!1}}]),t}();function Bt(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function It(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Bt(Object(r),!0).forEach((function(e){J(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Bt(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var At=function(){function t(e){c(this,t),this.cpu=void 0,this.selectedRegister=void 0,this.data=void 0,this.latchedData=void 0,this.prevClocks=void 0,this.cpu=e,this.selectedRegister=0,this.data={seconds:0,minutes:0,hours:0,days:0,halted:!1},this.latchedData=null,this.prevClocks=0}return h(t,[{key:"load",value:function(t,e){this.prevClocks=0,this.data=function(t,e){if(e+48>t.length)return{seconds:0,minutes:0,hours:0,days:0,halted:!1};var r=t[e],n=t[e+4],i=t[e+8],a=t[e+12]|t[e+16]<<8,s=new DataView(t.buffer,t.byteOffset+e),o=s.getUint32(40,!0)+4294967296*s.getUint32(44,!0),c=r+(Math.floor(Date.now()/1e3)-o),u=n+Math.floor(c/60),l=i+Math.floor(u/60);return{seconds:c%60,minutes:u%60,hours:l%24,days:a+Math.floor(l/24),halted:!1}}(t,e),this.latchedData=null}},{key:"save",value:function(t,e){!function(t,e,r){e[r]=t.seconds,e[r+4]=t.minutes,e[r+8]=t.hours,e[r+12]=255&t.days,e[r+16]=t.days>>8&255,e[r+20]=t.seconds,e[r+24]=t.minutes,e[r+28]=t.hours,e[r+32]=255&t.days,e[r+36]=t.days>>8&255;var n=new DataView(e.buffer,e.byteOffset+r),i=Math.floor(Date.now()/1e3);n.setUint32(40,i%4294967296,!0),n.setUint32(44,Math.floor(i/4294967296),!0)}(this.data,t,e)}},{key:"serialize",value:function(){var t={};return t.selectedRegister=this.selectedRegister,t.data=It({},this.data),t.latchedData=this.latchedData,t.prevClocks=this.prevClocks,t}},{key:"deserialize",value:function(t){var e;this.selectedRegister=t.selectedRegister,this.data=It({},t.data),this.latchedData=null!==(e=t.latchedData)&&void 0!==e?e:null,this.prevClocks=t.prevClocks}},{key:"reset",value:function(){this.prevClocks=0}},{key:"_updateRTC",value:function(){var t=this.cpu.clocks;if(this.data.halted)this.prevClocks=t;else{var e=t-this.prevClocks,r=Math.floor(e/1048576);if(r>0){var n=Math.min(this.data.seconds,59)+r,i=Math.min(this.data.minutes,59)+Math.floor(n/60),a=Math.min(this.data.hours,23)+Math.floor(i/60),s=this.data.days+Math.floor(a/24);this.data.seconds=n%60,this.data.minutes=i%60,this.data.hours=a%24,this.data.days=s,this.prevClocks+=1048576*r}}}},{key:"read",value:function(t){if(t>=40960&&t<49152){var e;this._updateRTC();var r=null!==(e=this.latchedData)&&void 0!==e?e:this.data;switch(this.selectedRegister){case 8:return r.seconds;case 9:return r.minutes;case 10:return r.hours;case 11:return 255&r.days;case 12:var n=r.days>>>8&1;return r.halted&&(n|=64),r.days>=512&&(n|=128),n;default:return 255}}return 255}},{key:"write",value:function(t,e){if(t>=16384&&t<24576)this.selectedRegister=e;else if(t>=40960&&t<49152)switch(this._updateRTC(),this.selectedRegister){case 8:this.data.seconds=e;break;case 9:this.data.minutes=e;break;case 10:this.data.hours=e;break;case 11:this.data.days=-256&this.data.days|255&e;break;case 12:this.data.days=-257&this.data.days|(1&e)<<8,this.data.halted=0!==(64&e),0!==(128&e)&&(this.data.days=511&this.data.days)}else t>=24576&&t<32768&&1===e&&(this._updateRTC(),null!=this.latchedData?this.latchedData=null:this.latchedData=It({},this.data))}}]),t}(),Mt=function(){function t(e,r,n,i){c(this,t),this.rom=void 0,this.ram=void 0,this.hasRTC=void 0,this.rtc=void 0,this.romBank=1,this.ramBank=0,this.ramEnabled=!0,this.ramUpdated=!1,this.rom=e,this.ram=r,this.rtc=new At(n),this.hasRTC=i}return h(t,[{key:"loadRAM",value:function(t){this.hasRTC?(this.ram=t.slice(0,this.ram.length),this.rtc.load(t,this.ram.length)):this.ram=t}},{key:"serializeRAM",value:function(){if(this.hasRTC){var t=new Uint8Array(this.ram.length+48);return t.set(this.ram,0),this.rtc.save(t,this.ram.length),t}return this.ram}},{key:"serialize",value:function(){var t={};return t.ram=null!=this.ram?f(this.ram):null,t.rtc=this.rtc.serialize(),t.romBank=this.romBank,t.ramBank=this.ramBank,t.ramEnabled=this.ramEnabled,t.ramUpdated=this.ramUpdated,t}},{key:"deserialize",value:function(t){null!=this.ram&&d(t.ram,this.ram),this.rtc.deserialize(t.rtc),this.romBank=t.romBank,this.ramBank=t.ramBank,this.ramEnabled=t.ramEnabled,this.ramUpdated=t.ramUpdated}},{key:"getDebugState",value:function(){return["ROM Bank: ".concat(this.romBank," RAM Bank: ").concat(this.ramBank)].join("\n")}},{key:"read",value:function(t){return t<16384?this.rom[t]:t<32768?this.rom[(16384*this.romBank+(t-16384))%this.rom.length]:t<40960?0:t<49152?this.ramEnabled?this.ramBank<3?null==this.ram?255:this.ram[(8192*this.ramBank+(t-40960))%this.ram.length]:this.rtc.read(t):255:0}},{key:"write",value:function(t,e){if(t<8192)this.ramEnabled=0!==(10&e);else{if(t<16384)return this.romBank=127&e,void(0===this.romBank&&(this.romBank=1));if(t<24576)return this.ramBank=15&e,void this.rtc.write(t,e);if(t<32768)this.rtc.write(t,e);else if(!(t<40960)&&t<49152){if(!this.ramEnabled)return;if(this.ramBank<3){if(null==this.ram)return;this.ram[(8192*this.ramBank+(t-40960))%this.ram.length]=e,this.ramUpdated=!0}else this.rtc.write(t,e)}}}},{key:"reset",value:function(){this.romBank=1,this.ramBank=0}}]),t}(),Rt=function(){function t(e,r){c(this,t),this.rom=void 0,this.ram=void 0,this.romBank=1,this.ramBank=0,this.ramEnabled=!0,this.initialTime=Date.now(),this.latchedTime=null,this.ramUpdated=!1,this.rom=e,this.ram=r}return h(t,[{key:"loadRAM",value:function(t){this.ram=t}},{key:"serializeRAM",value:function(){return this.ram}},{key:"serialize",value:function(){var t={};return t.ram=null!=this.ram?f(this.ram):null,t.romBank=this.romBank,t.ramBank=this.ramBank,t.ramEnabled=this.ramEnabled,t.ramUpdated=this.ramUpdated,t}},{key:"deserialize",value:function(t){null!=this.ram&&d(t.ram,this.ram),this.romBank=t.romBank,this.ramBank=t.ramBank,this.ramEnabled=t.ramEnabled,this.ramUpdated=t.ramUpdated}},{key:"getDebugState",value:function(){return["ROM Bank: ".concat(this.romBank," RAM Bank: ").concat(this.ramBank)].join("\n")}},{key:"read",value:function(t){return t<16384?this.rom[t]:t<32768?this.rom[(16384*this.romBank+(t-16384))%this.rom.length]:t<40960?0:t<49152?null==this.ram?255:this.ram[(8192*this.ramBank+(t-40960))%this.ram.length]:0}},{key:"write",value:function(t,e){if(t<8192)this.ramEnabled=0!==(10&e);else if(t<12288)this.romBank=256&this.romBank|255&e;else if(t<16384)this.romBank=e<<8&256|255&this.romBank;else if(t<24576)this.ramBank=15&e;else if(!(t<40960)&&t<49152){if(null==this.ram)return;this.ram[(8192*this.ramBank+(t-40960))%this.ram.length]=e,this.ramUpdated=!0}}},{key:"reset",value:function(){this.romBank=1,this.ramBank=0}}]),t}(),Tt=function(){function t(e,r){c(this,t),this.info=void 0,this.mbc=void 0,this.info=e,this.mbc=r}return h(t,[{key:"register",value:function(t){t.memoryBus.register(0,127,this.mbc),t.memoryBus.register(160,191,this.mbc,0)}},{key:"reset",value:function(){this.mbc.reset()}}]),t}();function Lt(t,e){return xt.apply(this,arguments)}function xt(){return(xt=o(a().mark((function t(e,r){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ct(r);case 2:n=t.sent,a=n.ramSize,i=0===a?null:new Uint8Array(a),t.t0=n.cartridgeType.mbcType,t.next=t.t0===yt.ROM?7:t.t0===yt.MBC1?8:t.t0===yt.MBC3?9:t.t0===yt.MBC5?10:11;break;case 7:case 9:return t.abrupt("return",new Tt(n,new Mt(r,i,e,n.cartridgeType.hasTimer)));case 8:return t.abrupt("return",new Tt(n,new _t(r,i)));case 10:return t.abrupt("return",new Tt(n,new Rt(r,i)));case 11:throw console.log(n),new Error("This cartridge is not supported yet");case 13:case"end":return t.stop()}var a}),t)})))).apply(this,arguments)}var Ot=r(842),zt=r.n(Ot);function jt(t){return Nt.apply(this,arguments)}function Nt(){return(Nt=o(a().mark((function t(e){var r,n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r="save-".concat(e.sha1Sum),t.next=3,zt().getItem(r);case 3:if(null!=(n=t.sent)){t.next=6;break}return t.abrupt("return",null);case 6:return t.abrupt("return",n.data);case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Pt(t,e){return Ft.apply(this,arguments)}function Ft(){return(Ft=o(a().mark((function t(e,r){var n,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n="save-".concat(e.sha1Sum),i={title:e.title,data:r},t.next=4,zt().setItem(n,i);case 4:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Ut=["initialVolume","currentVolume","increasing","pace","clock"],Wt=function(){function t(){c(this,t),this.initialVolume=0,this.currentVolume=0,this.increasing=!1,this.pace=0,this.clock=0}return h(t,[{key:"reset",value:function(){this.initialVolume=0,this.currentVolume=0,this.increasing=!1,this.pace=0,this.clock=0}},{key:"serialize",value:function(){var t=this,e={};return Ut.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Ut.forEach((function(r){return e[r]=t[r]}))}},{key:"trigger",value:function(){this.currentVolume=this.initialVolume,this.clock=0}},{key:"getDebugState",value:function(){return"V: ".concat(this.currentVolume.toString(16)," EP: ").concat(this.increasing?"+":"-").concat(this.pace.toString(16))}},{key:"get",value:function(){return this.currentVolume/15}},{key:"getNextClocks",value:function(t){if(0===this.pace)return t;var e=65536*this.pace-this.clock;return Math.min(t,e)}},{key:"step",value:function(t){var e=65536*this.pace;this.clock+=t,this.pace>0&&this.clock>=e&&(this.clock=0,this.increasing?this.currentVolume=Math.min(this.currentVolume+1,15):this.currentVolume=Math.max(this.currentVolume-1,0))}},{key:"read",value:function(t){if(2===t){var e=256;return e|=7&this.pace,this.increasing&&(e|=8),e|=(15&this.initialVolume)<<4}return 0}},{key:"write",value:function(t,e){2===t&&(this.pace=7&e,this.increasing=0!==(8&e),this.initialVolume=e>>4&15)}}]),t}(),Ht=["enabled","initialLength","currentLength","clock"],Gt=function(){function t(e){c(this,t),this.enabled=!1,this.initialLength=0,this.currentLength=0,this.clock=0,this.config=void 0,this.config=e}return h(t,[{key:"reset",value:function(){this.enabled=!1,this.initialLength=0,this.currentLength=0,this.clock=0}},{key:"serialize",value:function(){var t=this,e={};return Ht.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Ht.forEach((function(r){return e[r]=t[r]}))}},{key:"trigger",value:function(){this.currentLength=this.initialLength,this.clock=0}},{key:"getDebugState",value:function(){return"L: ".concat(this.enabled?this.currentLength.toString(16).padStart(2,"0"):"-1")}},{key:"getNextClocks",value:function(t){if(!this.enabled)return t;var e=16384-this.clock;return Math.min(t,e)}},{key:"step",value:function(t){this.clock+=t,this.enabled&&this.clock>=16384&&(this.clock=0,this.currentLength=Math.min(this.currentLength+1,64),64===this.currentLength&&(this.config.enabled=!1))}},{key:"read",value:function(t){if(4===t){var e=256;return this.enabled&&(e|=8),e}return 0}},{key:"write",value:function(t,e){1===t?this.initialLength=31&e:4===t&&(this.enabled=0!==(64&e))}}]),t}(),Vt=["enabled","phaseClock","clockShift","clockDivider","lfsr","lfsr7Bit"],qt=function(){function t(){c(this,t),this.output=0,this.enabled=!1,this.phaseClock=0,this.clockShift=0,this.clockDivider=0,this.lfsr=0,this.lfsr7Bit=!1,this.envelope=void 0,this.length=void 0,this.envelope=new Wt,this.length=new Gt(this),this.reset()}return h(t,[{key:"reset",value:function(){this.output=0,this.enabled=!1,this.phaseClock=0,this.clockShift=0,this.clockDivider=0,this.lfsr=0,this.lfsr7Bit=!1,this.envelope.reset(),this.length.reset()}},{key:"serialize",value:function(){var t=this,e={};return Vt.forEach((function(r){return e[r]=t[r]})),e.envelope=this.envelope.serialize(),e.length=this.length.serialize(),e}},{key:"deserialize",value:function(t){var e=this;Vt.forEach((function(r){return e[r]=t[r]})),this.envelope.deserialize(t.envelope),this.length.deserialize(t.length)}},{key:"trigger",value:function(){this.output=0,this.enabled=!0,this.phaseClock=0,this.lfsr=0,this.envelope.trigger(),this.length.trigger()}},{key:"getDebugState",value:function(){var t=this.clockDivider;0===t&&(t=.5);var e=16*t*(1<<this.clockShift),r=Math.floor(4194304/e);return["E: ".concat(this.enabled?"1":"0"," S: ").concat(this.clockShift," D: ").concat(this.clockDivider," (").concat(r,"Hz)"),this.envelope.getDebugState(),this.length.getDebugState()].join(" ")}},{key:"step",value:function(t){for(var e=t;e>0&&this.enabled;){var r=this.clockDivider;0===r&&(r=.5);var n=16*r*(1<<this.clockShift),i=n-this.phaseClock,a=Math.min(i,e);if(a=this.envelope.getNextClocks(a),a=this.length.getNextClocks(a),this.phaseClock+=a,this.phaseClock>=n){this.phaseClock=0;var s=this.lfsr7Bit?32896:32768,o=this.lfsr;o|=(1&o)!==(o>>1&1)?0:s,o>>>=1,this.lfsr=o}this.envelope.step(a),this.length.step(a),e-=a}if(this.enabled){var c=1&this.lfsr;this.output=(c?-1:1)*this.envelope.get()}else this.output=0}},{key:"_read",value:function(t){if(3===t){var e=256;return e|=(15&this.clockShift)<<4,this.lfsr7Bit&&(e|=8),e|=7&this.clockDivider}return 0}},{key:"read",value:function(t){var e=this._read(t);return e|=this.envelope.read(t),256&(e|=this.length.read(t))?e:255}},{key:"_write",value:function(t,e){switch(t){case 3:this.clockShift=e>>4&15,this.lfsr7Bit=0!==(8&e),this.clockDivider=7&e;break;case 4:128&e&&this.trigger()}}},{key:"write",value:function(t,e){this._write(t,e),this.envelope.write(t,e),this.length.write(t,e)}}]),t}(),Yt=[0,1,.5,.25],Kt=["dacEnabled","enabled","phase","phaseClock","wavelength","outputLevel"],Jt=function(){function t(e){c(this,t),this.output=0,this.dacEnabled=!1,this.enabled=!1,this.phase=0,this.phaseClock=0,this.wavelength=0,this.outputLevel=0,this.waveTable=void 0,this.length=void 0,this.length=new Gt(this),this.waveTable=e,this.reset()}return h(t,[{key:"reset",value:function(){this.output=0,this.dacEnabled=!1,this.enabled=!1,this.phase=0,this.phaseClock=0,this.wavelength=0,this.outputLevel=0,this.length.reset()}},{key:"serialize",value:function(){var t=this,e={};return Kt.forEach((function(r){return e[r]=t[r]})),e.length=this.length.serialize(),e}},{key:"deserialize",value:function(t){var e=this;Kt.forEach((function(r){return e[r]=t[r]})),this.length.deserialize(t.length)}},{key:"trigger",value:function(){this.output=0,this.enabled=!0,this.dacEnabled=!0,this.phase=0,this.phaseClock=0,this.length.trigger()}},{key:"getDebugState",value:function(){return["E: ".concat(this.enabled?"1":"0"," WL: ").concat(this.wavelength.toString(16).padStart(3,"0")," (").concat(this.getHz(),"Hz) V: ").concat(this.outputLevel),this.length.getDebugState()].join(" ")}},{key:"getHz",value:function(){return Math.floor(4194304/(64*(2048-this.wavelength)))}},{key:"step",value:function(t){for(var e=t;e>0&&this.enabled&&this.dacEnabled;){var r=2*(2048-this.wavelength),n=r-this.phaseClock,i=Math.min(n,e);i=this.length.getNextClocks(i),this.phaseClock+=i,this.phaseClock>=r&&(this.phaseClock=0,this.phase=(this.phase+1)%32),this.length.step(i),e-=i}if(this.enabled&&this.dacEnabled){var a=this.phase>>1,s=1&this.phase,o=(this.waveTable.read(a)>>(s?0:4)&15)/15;this.output=(2*o-1)*Yt[this.outputLevel]}else this.output=0}},{key:"_read",value:function(t){switch(t){case 0:var e=256;return this.dacEnabled&&(e|=128),e;case 2:return 256|(3&this.outputLevel)<<5;case 3:return 256|255&this.wavelength;case 4:return 256|this.wavelength>>8&7;default:return 0}}},{key:"read",value:function(t){var e=this._read(t);return 256&(e|=this.length.read(t))?e:255}},{key:"_write",value:function(t,e){switch(t){case 0:this.dacEnabled=0!==(128&e);break;case 2:this.outputLevel=e>>5&3;break;case 3:this.wavelength=1792&this.wavelength|255&e;break;case 4:this.wavelength=255&this.wavelength|(7&e)<<8,128&e&&this.trigger()}}},{key:"write",value:function(t,e){this._write(t,e),this.length.write(t,e)}}]),t}(),Xt=["initialPace","pace","increasing","slope","clock"],Qt=function(){function t(e){c(this,t),this.initialPace=0,this.pace=0,this.increasing=!1,this.slope=0,this.clock=0,this.config=void 0,this.config=e}return h(t,[{key:"reset",value:function(){this.initialPace=0,this.pace=0,this.increasing=!1,this.slope=0,this.clock=0}},{key:"serialize",value:function(){var t=this,e={};return Xt.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Xt.forEach((function(r){return e[r]=t[r]}))}},{key:"trigger",value:function(){this.clock=0,this.pace=this.initialPace}},{key:"getDebugState",value:function(){return"SP: ".concat(this.increasing?"+":"-").concat(this.pace.toString(16)," ").concat(this.slope.toString(16))}},{key:"getNextClocks",value:function(t){if(0===this.pace)return t;var e=32768*this.pace-this.clock;return Math.min(t,e)}},{key:"step",value:function(t){var e=32768*this.pace;if(this.clock+=t,this.pace>0&&this.clock>=e){this.clock=0;var r=this.config.wavelength,n=r+(r>>>this.slope)*(this.increasing?1:-1);n>=2047?(this.config.enabled=!1,this.config.wavelength=2047):this.config.wavelength=n}}},{key:"read",value:function(t){if(0===t){var e=256;return e|=7&this.slope,this.increasing||(e|=8),e|=(7&this.initialPace)<<4}return 0}},{key:"write",value:function(t,e){0===t&&(this.slope=7&e,this.increasing=0===(8&e),this.initialPace=e>>4&7,0===this.initialPace?this.pace=0:0===this.pace&&(this.pace=this.initialPace))}}]),t}(),Zt=[254,126,120,129],$t=["enabled","phase","phaseClock","wavelength","dutyCycle"],te=function(){function t(e){c(this,t),this.output=0,this.enabled=!1,this.phase=0,this.phaseClock=0,this.wavelength=0,this.dutyCycle=0,this.sweep=void 0,this.envelope=void 0,this.length=void 0,this.hasSweep=void 0,this.hasSweep=null===e||void 0===e||e,this.sweep=new Qt(this),this.envelope=new Wt,this.length=new Gt(this),this.reset()}return h(t,[{key:"reset",value:function(){this.output=0,this.enabled=!1,this.phase=0,this.phaseClock=0,this.wavelength=0,this.dutyCycle=0,this.sweep.reset(),this.envelope.reset(),this.length.reset()}},{key:"serialize",value:function(){var t=this,e={};return $t.forEach((function(r){return e[r]=t[r]})),e.sweep=this.sweep.serialize(),e.envelope=this.envelope.serialize(),e.length=this.length.serialize(),e}},{key:"deserialize",value:function(t){var e=this;$t.forEach((function(r){return e[r]=t[r]})),this.sweep.deserialize(t.sweep),this.envelope.deserialize(t.envelope),this.length.deserialize(t.length)}},{key:"trigger",value:function(){this.output=0,this.enabled=!0,this.phase=0,this.phaseClock=0,this.sweep.trigger(),this.envelope.trigger(),this.length.trigger()}},{key:"getDebugState",value:function(){return["E: ".concat(this.enabled?"1":"0"," WL: ").concat(this.wavelength.toString(16).padStart(3,"0")," (").concat(this.getHz(),"Hz) DC: ").concat(this.dutyCycle),this.hasSweep?this.sweep.getDebugState():"",this.envelope.getDebugState(),this.length.getDebugState()].filter((function(t){return""!==t})).join(" ")}},{key:"getHz",value:function(){return Math.floor(4194304/(32*(2048-this.wavelength)))}},{key:"step",value:function(t){for(var e=t;e>0&&this.enabled;){var r=4*(2048-this.wavelength),n=r-this.phaseClock,i=Math.min(n,e);this.hasSweep&&(i=this.sweep.getNextClocks(i)),i=this.envelope.getNextClocks(i),i=this.length.getNextClocks(i),this.phaseClock+=i,this.phaseClock>=r&&(this.phaseClock=0,this.phase=(this.phase+1)%8),this.hasSweep&&this.sweep.step(i),this.envelope.step(i),this.length.step(i),e-=i}if(this.enabled){var a=Zt[this.dutyCycle]>>7-this.phase&1;this.output=(a?-1:1)*this.envelope.get()}else this.output=0}},{key:"_read",value:function(t){switch(t){case 1:return 256|(3&this.dutyCycle)<<6;case 3:return 256|255&this.wavelength;case 4:return 256|this.wavelength>>8&7;default:return 0}}},{key:"read",value:function(t){var e=this._read(t);return this.hasSweep&&(e|=this.sweep.read(t)),e|=this.envelope.read(t),256&(e|=this.length.read(t))?e:255}},{key:"_write",value:function(t,e){switch(t){case 1:this.dutyCycle=e>>6&3;break;case 3:this.wavelength=1792&this.wavelength|255&e;break;case 4:this.wavelength=255&this.wavelength|(7&e)<<8,128&e&&this.trigger()}}},{key:"write",value:function(t,e){this._write(t,e),this.hasSweep&&this.sweep.write(t,e),this.envelope.write(t,e),this.length.write(t,e)}}]),t}(),ee=32768,re=Math.ceil(ee/60),ne=Math.ceil(ee/60),ie=["clocks","nr50","nr51","nr52"],ae=function(){function t(){c(this,t),this.audioContext=void 0,this.audioWorkletNode=void 0,this.buffer=void 0,this.clocks=void 0,this.bufferPos=void 0,this.psgs=void 0,this.waveTable=void 0,this.nr50=void 0,this.nr51=void 0,this.nr52=void 0,this.audioContext=null,this.audioWorkletNode=null,this.buffer=new Float32Array(2*re),this.clocks=0,this.bufferPos=0,this.waveTable=new w(16),this.psgs=[new te,new te(!1),new Jt(this.waveTable),new qt],this.nr50=0,this.nr51=0,this.nr52=0}return h(t,[{key:"setup",value:function(){var t=o(a().mark((function t(){var e;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null==this.audioContext){t.next=2;break}return t.abrupt("return");case 2:return this.audioContext=new AudioContext({sampleRate:ee}),t.next=5,this.audioContext.audioWorklet.addModule("./audioWorklet.js");case 5:this.audioWorkletNode=new AudioWorkletNode(this.audioContext,"gb-passthrough",{numberOfOutputs:1,outputChannelCount:[2]}),e=new BiquadFilterNode(this.audioContext,{type:"highpass",Q:10,frequency:100}),this.audioWorkletNode.connect(e),e.connect(this.audioContext.destination);case 9:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"reset",value:function(){this.buffer=new Float32Array(2*re),this.clocks=0,this.bufferPos=0,this.waveTable.reset(),this.psgs.forEach((function(t){return t.reset()})),this.nr50=0,this.nr51=0,this.nr52=0}},{key:"register",value:function(t){t.ioBus.registerMemory(16,48,"APU",this)}},{key:"serialize",value:function(){var t=this,e={};return e.waveTable=this.waveTable.serialize(),e.psgs=this.psgs.map((function(t){return t.serialize()})),ie.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;this.clocks=t.clocks,this.waveTable.deserialize(t.waveTable),this.psgs.forEach((function(e,r){return e.deserialize(t.psgs[r])})),ie.forEach((function(r){return e[r]=t[r]}))}},{key:"read",value:function(t){var e=Math.floor(t/5);if(e<4)return this.psgs[e].read(t%5);if(t>=32)return this.waveTable.read(t-32);switch(t){case 20:return this.nr50;case 21:return this.nr51;case 22:for(var r=this.nr52,n=0;n<this.psgs.length;n+=1)this.psgs[n].enabled&&(r|=1<<n);return r;default:return 255}}},{key:"write",value:function(t,e){var r=Math.floor(t/5);if(r<4)return this.psgs[r].write(t%5,e);if(t>=32)return this.waveTable.write(t-32,e);switch(t){case 20:this.nr50=e;break;case 21:this.nr51=e;break;case 22:this.nr52=128&e}}},{key:"step",value:function(t){if(0!==(128&this.nr52))for(var e=0;e<this.psgs.length;e+=1)this.psgs[e].step(t)}},{key:"getOutput",value:function(t){if(0===(128&this.nr52))return 0;for(var e=this.nr51,r=this.nr50,n=0,i=0;i<4;i+=1)e&1<<4*t+i&&(n+=this.psgs[i].output);return(n*=0===t?(r>>>4&7)/7:(7&r)/7)/4}},{key:"advanceClock",value:function(){this.clocks+=4;for(var t=Math.floor(this.clocks/128);this.bufferPos<t;){this.step(Math.floor(128));for(var e=0;e<2;e+=1){var r=re*e;this.buffer[r+this.bufferPos]=this.getOutput(e)}this.bufferPos+=1}}},{key:"finalize",value:function(){for(;this.bufferPos<ne;){this.step(Math.floor(128));for(var t=0;t<2;t+=1){var e=re*t;this.buffer[e+this.bufferPos]=this.getOutput(t)}this.bufferPos+=1}null!=this.audioWorkletNode&&this.audioWorkletNode.port.postMessage({buffer:this.buffer,size:re,writeSize:ne}),this.buffer=new Float32Array(2*re),this.bufferPos=0,this.clocks=0}},{key:"getDebugState",value:function(){var t=[];this.psgs.forEach((function(e,r){t.push("NR".concat(r+1,": ")+e.getDebugState()+"\n")})),t.push("NR5: V: ".concat(this.nr50.toString(16).padStart(2,"0")," P: ").concat(this.nr51.toString(16).padStart(2,"0")," E: ").concat(0!==(128&this.nr52),"\n")),t.push("Wave: ");for(var e=0;e<16;e+=1)t.push(this.waveTable.bytes[e].toString(16).padStart(2,"0"));return t.join("")}}]),t}(),se=function(){function t(){var e=this;c(this,t),this.bank=void 0,this.ram=void 0,this.bank=1,this.ram=new p(32768,(function(){return!1}),(function(t){return t<4096?0:4096*e.bank-4096}))}return h(t,[{key:"serialize",value:function(){return{ram:this.ram.serialize(),bank:this.bank}}},{key:"deserialize",value:function(t){this.bank=t.bank,this.ram.deserialize(t.ram)}},{key:"reset",value:function(){this.bank=1,this.ram.reset()}},{key:"register",value:function(t){var e=this,r=t.ioBus,n=t.memoryBus;n.register(192,223,this.ram),n.register(224,253,this.ram),t.type===F.CGB&&r.register(112,"SVBK",{read:function(){return e.bank},write:function(t,r){e.bank=7&r,0===e.bank&&(e.bank=1)}})}}]),t}();function oe(r){return function(e){if(Array.isArray(e))return t(e)}(r)||function(t){if("undefined"!==typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(r)||e(r)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ce(t,e){var r=new Array(t);return e.forEach((function(t){var e=n(t,2);!function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=t.split("");(function t(i,a,s,o){var c=n[i],u=o,l=s;if(i===n.length||i>0&&n[i-1]!==c){var h=n[i-1];"1"!==h&&"0"!==h&&(u=It(It({},o),{},J({},h,s)),l=0)}if(i!==n.length){var f=a<<1;return"1"===c?t(i+1,f|=1,l,u):"0"===c?t(i+1,f,l,u):(t(i+1,f,l<<=1,u),t(i+1,1|f,1|l,u))}r[a]=e(u)})(0,0,0,{})}(e[0],e[1],r)})),r}function ue(t,e){var r=e;return r.opName=t,r}function le(t,e,r){var n=r;return n.opName=t,n.param=e,n}function he(t,e){var r=e;return r.opName=t,r}var fe=he("add",(function(t,e,r){var n=e+r;return t.aluSetFlags(0===(255&n),!1,0!==((15&e)+(15&r)&16),0!==(256&n)),255&n})),de=he("adc",(function(t,e,r){var n=t.getFlag(L)?1:0,i=e+r+n;return t.aluSetFlags(0===(255&i),!1,0!==((15&e)+(15&r)+n&16),0!==(256&i)),255&i})),ve=he("sub",(function(t,e,r){var n=e-r;return t.aluSetFlags(0===(255&n),!0,((15&e)-(15&r)|0)<0,n<0),255&n})),pe=he("sbc",(function(t,e,r){var n=t.getFlag(L)?1:0,i=e-r-n;return t.aluSetFlags(0===(255&i),!0,0!==((15&e)-(15&r)-n&16),i<0),255&i})),ge=he("and",(function(t,e,r){var n=e&r;return t.aluSetFlags(0===(255&n),!1,!0,!1),255&n})),me=he("or",(function(t,e,r){var n=e|r;return t.aluSetFlags(0===(255&n),!1,!1,!1),255&n})),ye=[fe,de,ve,pe,ge,he("xor",(function(t,e,r){var n=e^r;return t.aluSetFlags(0===(255&n),!1,!1,!1),255&n})),me,he("cp",(function(t,e,r){var n=e-r;return t.aluSetFlags(0===(255&n),!0,((15&e)-(15&r)|0)<0,n<0),e}))],be=ue("inc",(function(t,e){var r=e+1;return t.aluSetFlags(255===e,!1,15===(15&e),t.getFlag(L)),255&r})),ke=ue("dec",(function(t,e){var r=e-1;return t.aluSetFlags(1===e,!0,0===(15&e),t.getFlag(L)),255&r})),we=ue("swap",(function(t,e){var r=(15&e)<<4|e>>>4&15;return t.aluSetFlags(0===(255&r),!1,!1,!1),255&r})),Se=function(t){return ue(t?"rlc":"rlca",(function(e,r){var n=128&r,i=r<<1&255|n>>>7;return e.aluSetFlags(t&&0===i,!1,!1,0!==n),i}))},Ee=function(t){return ue(t?"rl":"rla",(function(e,r){var n=128&r,i=r<<1&255|(e.getFlag(L)?1:0);return e.aluSetFlags(t&&0===i,!1,!1,0!==n),i}))},Ce=function(t){return ue(t?"rrc":"rrca",(function(e,r){var n=1&r,i=r>>>1&255|n<<7;return e.aluSetFlags(t&&0===i,!1,!1,0!==n),i}))},De=function(t){return ue(t?"rr":"rra",(function(e,r){var n=1&r,i=r>>>1&255|(e.getFlag(L)?1:0)<<7;return e.aluSetFlags(t&&0===i,!1,!1,0!==n),i}))},_e=ue("sla",(function(t,e){var r=128&e,n=e<<1&255;return t.aluSetFlags(0===n,!1,!1,0!==r),n})),Be=ue("sra",(function(t,e){var r=1&e,n=e>>>1&255|128&e;return t.aluSetFlags(0===n,!1,!1,0!==r),n})),Ie=ue("srl",(function(t,e){var r=1&e,n=e>>>1&255;return t.aluSetFlags(0===n,!1,!1,0!==r),n})),Ae=[Se(!0),Ce(!0),Ee(!0),De(!0),_e,Be,we,Ie],Me=function(t,e,r){return function(n,i){var a;1===r?(a=e.read(n),e.clocks>0&&n.tick(e.clocks),e.write(n,t(n,a)),n.skip(1),n.tick(e.clocks+r)):(e.clocks>0&&n.tick(e.clocks),a=e.read(n),e.clocks>0&&n.tick(e.clocks),e.write(n,t(n,a)),n.skip(2),n.tick(r)),n.isDebugging&&n.log("op","".concat(t.opName," ").concat(t.param?"".concat(t.param,", "):"").concat(e.name),i,"".concat(e.name,"=").concat(N(a)," ").concat(n.getDebugFlags()))}},Re=[function(t){return!t.getFlag(z)},function(t){return t.getFlag(z)},function(t){return!t.getFlag(L)},function(t){return t.getFlag(L)}],Te=function(t,e){var r=t.memory.read(e+1);t.tick(1);var n=t.memory.read(e+2);t.tick(3);var i=r|n<<8;t.skip(3),t.registers[R]=i,t.isDebugging&&t.log("op","jp ".concat(j(i)),e,"pc=".concat(j(i)))},Le=function(t,e){var r=t.readHL();t.skip(1),t.registers[R]=r,t.tick(1),t.isDebugging&&t.log("op","jp hl",e,"pc=".concat(j(r)))},xe=function(t,e){var r=t.memory.read(e+1);128&r&&(r=-(1+~r&255));var n=t.registers[R]+2+r&65535;t.skip(2),t.registers[R]=n,t.tick(3),t.isDebugging&&(r>0?t.log("op","jr ".concat(N(r)),e,"pc=".concat(j(n))):t.log("op","jr -".concat(N(-r)),e,"pc=".concat(j(n))))},Oe=function(t,e){var r=t.memory.read(e+1);t.tick(1);var n=t.memory.read(e+2);t.tick(2);var i=r|n<<8,a=e+3,s=t.registers[T];t.memory.write(s-1,a>>>8&255),t.tick(1),t.memory.write(s-2,255&a),t.tick(2);var o=s-2&65535;t.registers[T]=o,t.skip(3),t.registers[R]=i,t.isDebugging&&t.log("op","call ".concat(j(i)),e,"pc=".concat(j(i)," sp=").concat(j(o)))},ze=function(t,e){var r=t.registers[T],n=t.memory.read(r);t.tick(1);var i=t.memory.read(r+1);t.tick(3);var a=n|i<<8,s=r+2&65535;t.registers[T]=s,t.skip(1),t.registers[R]=a,t.isDebugging&&t.log("op","ret",e,"pc=".concat(j(a)," sp=").concat(j(s)))},je=function(t,e){var r=t.registers[T],n=t.memory.read(r);t.tick(1);var i=t.memory.read(r+1);t.tick(3);var a=n|i<<8,s=r+2&65535;t.registers[T]=s,t.skip(1),t.registers[R]=a,t.isInterruptsEnabled=!0,t.isInterruptsEnabledNext=!0,t.isDebugging&&t.log("op","reti",e,"pc=".concat(j(a)," sp=").concat(j(s)))},Ne=function(t,e){var r=t.memory.read(e+1)|t.memory.read(e+2)<<8;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.readBreakpoints.includes(r))t.isTrapped=!0;else{t.tick(2);var n=t.memory.read(r);t.registers[E]=n,t.skip(3),t.tick(2),t.isDebugging&&t.log("op","ld a, (".concat(j(r),")"),e,"a=".concat(N(n)))}},Pe=function(t,e){var r=t.memory.read(e+1)|t.memory.read(e+2)<<8;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.writeBreakpoints.includes(r))t.isTrapped=!0;else{t.tick(2);var n=t.registers[E];t.memory.write(r,n),t.skip(3),t.tick(2),t.isDebugging&&t.log("op","ld (".concat(j(r),"), a"),e,"(".concat(j(r),")=").concat(N(n)))}},Fe=function(t,e){var r=65280+t.registers[D]&65535;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.readBreakpoints.includes(r))t.isTrapped=!0;else{var n=t.memory.read(r);t.registers[E]=n,t.skip(1),t.tick(2),t.isDebugging&&t.log("op","ld a, ($ff00 + c)",e,"a=".concat(N(n)," (").concat(j(r),")"))}},Ue=function(t,e){var r=65280+t.registers[D]&65535;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.writeBreakpoints.includes(r))t.isTrapped=!0;else{var n=t.registers[E];t.memory.write(r,n),t.skip(1),t.tick(2),t.isDebugging&&t.log("op","ld ($ff00 + c), a",e,"(".concat(j(r),")=").concat(N(n)))}},We=function(t,e){var r=65280+t.memory.read(e+1)&65535;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.writeBreakpoints.includes(r))t.isTrapped=!0;else{t.tick(1);var n=t.registers[E];t.memory.write(r,n),t.skip(2),t.tick(2),t.isDebugging&&t.log("op","ldh (".concat(N(r),"), a"),e,"(".concat(j(r),")=").concat(N(n)))}},He=function(t,e){var r=65280+t.memory.read(e+1)&65535;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.readBreakpoints.includes(r))t.isTrapped=!0;else{t.tick(1);var n=t.memory.read(r);t.tick(2),t.registers[E]=n,t.skip(2),t.isDebugging&&t.log("op","ldh a, (".concat(N(r),")"),e,"a=".concat(N(n)))}},Ge=function(t,e){var r=t.memory.read(e+1)|t.memory.read(e+2)<<8;if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.writeBreakpoints.includes(r))t.isTrapped=!0;else{var n=t.registers[T];t.memory.write(r,255&n),t.memory.write(r+1,n>>>8&255),t.skip(3),t.tick(5),t.isDebugging&&t.log("op","ld (".concat(j(r),"), sp"),e,"(".concat(j(r),")=").concat(j(n)))}},Ve=function(t,e){t.registers[T]=t.readHL(),t.skip(1),t.tick(2),t.isDebugging&&t.log("op","ld sp, hl",e,"sp=".concat(j(t.readHL())))},qe=function(t,e){var r=t.registers[T],n=t.memory.read(e+1);128&n&&(n=-(1+~n&255));var i=r+n;t.writeHL(i),t.aluSetFlags(!1,!1,16===(16&(r^n^65535&i)),256===(256&(r^n^65535&i))),t.skip(2),t.tick(3),t.isDebugging&&(n>0?t.log("op","ld hl, (sp + ".concat(N(n),")"),e,"hl=".concat(j(i)," sp=").concat(j(r))):t.log("op","ld hl, (sp - ".concat(N(-n),")"),e,"hl=".concat(j(i)," sp=").concat(j(r))))},Ye=function(t,e){t.tick(1),t.skip(1),t.isDebugging&&t.log("op","nop",e)},Ke=function(t,e){var r=t.registers[T],n=t.memory.read(e+1);128&n&&(n=-(1+~n&255));var i=r+n;t.aluSetFlags(!1,!1,16===(16&(r^n^65535&i)),256===(256&(r^n^65535&i))),t.registers[T]=65535&i,t.skip(2),t.tick(4),t.isDebugging&&t.log("op","add sp, ".concat(n),e,"sp=".concat(j(65535&i)," ").concat(t.getDebugFlags()))},Je=function(t,e){var r=t.registers[E],n=!1,i=0;(t.getFlag(O)||!t.getFlag(x)&&(15&r)>9)&&(i|=6),(t.getFlag(L)||!t.getFlag(x)&&r>153)&&(i|=96,n=!0),r+=t.getFlag(x)?-i:i,t.aluSetFlags(0===(255&r),t.getFlag(x),!1,n),t.registers[E]=255&r,t.skip(1),t.tick(1),t.isDebugging&&t.log("op","daa",e,"a=".concat(N(255&r)," ").concat(t.getDebugFlags()))},Xe=function(t,e){var r=255^t.registers[E];t.aluSetFlags(t.getFlag(z),!0,!0,t.getFlag(L)),t.registers[E]=r,t.skip(1),t.tick(1),t.isDebugging&&t.log("op","cpl",e,"a=".concat(N(255&r)," ").concat(t.getDebugFlags()))},Qe=function(t,e){t.aluSetFlags(t.getFlag(z),!1,!1,!t.getFlag(L)),t.skip(1),t.tick(1),t.isDebugging&&t.log("op","ccf",e,"".concat(t.getDebugFlags()))},Ze=function(t,e){t.aluSetFlags(t.getFlag(z),!1,!1,!0),t.skip(1),t.tick(1),t.isDebugging&&t.log("op","scf",e,"".concat(t.getDebugFlags()))},$e=function(t,e){t.isRunning=!1,t.skip(1),t.tick(1),t.isDebugging&&t.log("op","halt",e,"IME=".concat(t.isInterruptsEnabled))},tr=function(t,e){t.isStopped=!0,t.isRunning=!1,t.skip(2),t.tick(1),t.isDebugging&&t.log("op","stop",e)},er=function(t,e){t.isInterruptsEnabled=!1,t.isInterruptsEnabledNext=!1,t.skip(1),t.tick(1),t.isDebugging&&t.log("op","di",e)},rr=function(t,e){t.isInterruptsEnabledNext=!0,t.skip(1),t.tick(1),t.isDebugging&&t.log("op","ei",e)},nr=function(t,e){return{name:e,read:function(e){return e.registers[t]},write:function(e,r){e.registers[t]=r},clocks:0}},ir=nr(E,"a"),ar=[nr(C,"b"),nr(D,"c"),nr(_,"d"),nr(B,"e"),nr(A,"h"),nr(M,"l"),{name:"(hl)",read:function(t){return t.memory.read(t.readHL())},write:function(t,e){return t.memory.write(t.readHL(),e)},clocks:1},ir],sr={name:"af",read:function(t){return t.registers[E]<<8|t.registers[I]},write:function(t,e){t.registers[E]=e>>>8&255,t.registers[I]=240&e},postCallback:function(){}},or={name:"bc",read:function(t){return t.registers[C]<<8|t.registers[D]},write:function(t,e){t.registers[C]=e>>>8&255,t.registers[D]=255&e},postCallback:function(){}},cr={name:"de",read:function(t){return t.registers[_]<<8|t.registers[B]},write:function(t,e){t.registers[_]=e>>>8&255,t.registers[B]=255&e},postCallback:function(){}},ur={name:"sp",read:function(t){return t.registers[T]},write:function(t,e){t.registers[T]=e},postCallback:function(){}},lr={name:"hl",read:function(t){return t.readHL()},write:function(t,e){return t.writeHL(e)},postCallback:function(){}},hr=It(It({},lr),{},{name:"hl+",postCallback:function(t){t.writeHL(t.readHL()+1&65535)}}),fr=It(It({},lr),{},{name:"hl-",postCallback:function(t){t.writeHL(t.readHL()-1&65535)}}),dr=[or,cr,lr,ur],vr=[or,cr,hr,fr],pr=[or,cr,lr,sr],gr=ce(256,[["00ooorrr",function(t){var e=t.o,r=t.r;return Me(Ae[e],ar[r],2)}],["01nnnrrr",function(t){var e,r=t.n,n=t.r;return function(t,e,r){return function(n,i){e.clocks>0&&n.tick(e.clocks);var a=e.read(n);t(n,a),n.skip(2),n.tick(r),n.isDebugging&&n.log("op","".concat(t.opName," ").concat(t.param?"".concat(t.param,", "):"").concat(e.name),i,"".concat(e.name,"=").concat(N(a)," ").concat(n.getDebugFlags()))}}(le("bit",(e=r).toString(),(function(t,r){var n=1<<e&r&255;return t.aluSetFlags(0===n,!1,!0,t.getFlag(L)),r})),ar[n],2)}],["10nnnrrr",function(t){var e,r=t.n,n=t.r;return Me(le("res",(e=r).toString(),(function(t,r){return 255&r&~(1<<e)})),ar[n],2)}],["11nnnrrr",function(t){var e,r=t.n,n=t.r;return Me(le("set",(e=r).toString(),(function(t,r){return 255&(1<<e|r)})),ar[n],2)}]]),mr=function(t,e){var r=t.memory.read(e+1);gr[r](t,e+1)},yr=ce(256,[["00000000",function(){return Ye}],["00001000",function(){return Ge}],["00010000",function(){return tr}],["00011000",function(){return xe}],["001cc000",function(t){var e,r=t.c;return e=Re[r],function(t,r){var n=t.memory.read(r+1);128&n&&(n=-(1+~n&255));var i="skip";if(e(t)){var a=t.registers[R]+2+n&65535;t.skip(2),t.registers[R]=a,t.tick(3),t.isDebugging&&(i="pc=".concat(j(a)))}else t.skip(2),t.tick(2);t.isDebugging&&(n>0?t.log("op","jr ".concat(e.name,", ").concat(N(n)),r,i):t.log("op","jr ".concat(e.name,", -").concat(N(-n)),r,i))}}],["00RR0001",function(t){var e,r=t.R;return e=dr[r],function(t,r){var n=t.memory.read(r+1)|t.memory.read(r+2)<<8;e.write(t,n),t.skip(3),e.postCallback(t),t.tick(3),t.isDebugging&&t.log("op","ld ".concat(e.name,", ").concat(j(n)),r,"".concat(e.name,"=").concat(j(n)))}}],["00RR1001",function(t){var e,r,n=t.R;return e=lr,r=dr[n],function(t,n){var i=e.read(t),a=r.read(t),s=i+a;t.aluSetFlags(t.getFlag(z),!1,0!==((4095&i)+(4095&a)&4096),0!==(65536&s)),e.write(t,65535&s),t.skip(1),e.postCallback(t),r.postCallback(t),t.tick(2),t.isDebugging&&t.log("op","add ".concat(e.name,", ").concat(r.name),n,"".concat(e.name,"=").concat(j(65535&s)," (").concat(j(i),", ").concat(j(a),") ").concat(t.getDebugFlags()))}}],["00RR0011",function(t){var e,r=t.R;return e=dr[r],function(t,r){var n=e.read(t)+1;e.write(t,65535&n),t.skip(1),e.postCallback(t),t.tick(2),t.isDebugging&&t.log("op","inc ".concat(e.name),r,"".concat(e.name,"=").concat(j(n)))}}],["00RR1011",function(t){var e,r=t.R;return e=dr[r],function(t,r){var n=e.read(t)-1;e.write(t,65535&n),t.skip(1),e.postCallback(t),t.tick(2),t.isDebugging&&t.log("op","dec ".concat(e.name),r,"".concat(e.name,"=").concat(j(n)))}}],["00RR0010",function(t){var e,r=t.R;return e=vr[r],function(t,r){var n=e.read(t);if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.writeBreakpoints.includes(n))t.isTrapped=!0;else{var i=t.registers[E];t.memory.write(n,i),t.skip(1),e.postCallback(t),t.tick(2),t.isDebugging&&t.log("op","ld (".concat(e.name,"), a"),r,"(".concat(j(n),")=").concat(N(i)))}}}],["00RR1010",function(t){var e,r=t.R;return e=vr[r],function(t,r){var n=e.read(t);if(!t.isTrapResolved&&t.isBreakpointsEnabled&&t.readBreakpoints.includes(n))t.isTrapped=!0;else{var i=t.memory.read(n);t.registers[E]=i,t.skip(1),e.postCallback(t),t.tick(2),t.isDebugging&&t.log("op","ld a, (".concat(e.name,")"),r,"a=".concat(N(i)," (").concat(j(n),")"))}}}],["00rrr100",function(t){var e=t.r;return Me(be,ar[e],1)}],["00rrr101",function(t){var e=t.r;return Me(ke,ar[e],1)}],["00rrr110",function(t){var e=t.r;return function(t){return function(e,r){t.clocks>0&&e.tick(t.clocks);var n=e.memory.read(r+1);t.write(e,n),e.skip(2),e.tick(2),e.isDebugging&&e.log("op","ld ".concat(t.name,", ").concat(N(n)),r,"".concat(t.name,"=").concat(N(n)))}}(ar[e])}],["00000111",function(){return Me(Se(!1),ir,1)}],["00001111",function(){return Me(Ce(!1),ir,1)}],["00010111",function(){return Me(Ee(!1),ir,1)}],["00011111",function(){return Me(De(!1),ir,1)}],["00100111",function(){return Je}],["00101111",function(){return Xe}],["00110111",function(){return Ze}],["00111111",function(){return Qe}],["01aaabbb",function(t){var e,r,n=t.a,i=t.b;return e=ar[n],r=ar[i],function(t,n){var i=r.read(t);e.write(t,i),t.skip(1),t.tick(e.clocks+r.clocks+1),t.isDebugging&&t.log("op","ld ".concat(e.name,", ").concat(r.name),n,"".concat(e.name,"=").concat(N(i)))}}],["01110110",function(){return $e}],["10ooorrr",function(t){var e,r,n=t.o,i=t.r;return e=ye[n],r=ar[i],function(t,n){var i=t.registers[E],a=r.read(t),s=e(t,i,a);t.registers[E]=s,t.skip(1),t.tick(1+r.clocks),t.isDebugging&&t.log("op","".concat(e.opName," ").concat(r.name),n,"a=".concat(N(s)," (").concat(N(i),", ").concat(N(a),") ").concat(t.getDebugFlags()))}}],["110cc000",function(t){var e,r=t.c;return e=Re[r],function(t,r){if(e(t)){var n=t.registers[T];t.tick(1);var i=t.memory.read(n);t.tick(1);var a=t.memory.read(n+1);t.tick(3);var s=i|a<<8,o=n+2&65535;t.registers[T]=o,t.skip(1),t.registers[R]=s,t.isDebugging&&t.log("op","ret ".concat(e.name),r,"pc=".concat(j(s)," sp=").concat(j(o)))}else t.skip(1),t.tick(2),t.isDebugging&&t.log("op","ret ".concat(e.name),r,"skip")}}],["110cc010",function(t){var e,r=t.c;return e=Re[r],function(t,r){if(e(t)){var n=t.memory.read(r+1);t.tick(1);var i=t.memory.read(r+2);t.tick(3);var a=n|i<<8;t.skip(3),t.registers[R]=a,t.isDebugging&&t.log("op","jp ".concat(e.name,", ").concat(j(a)),r,"pc=".concat(j(a)))}else if(t.skip(3),t.tick(3),t.isDebugging){var s=t.memory.read(r+1)|t.memory.read(r+2)<<8;t.log("op","jp ".concat(e.name,", ").concat(j(s)),r,"skip")}}}],["110cc100",function(t){var e,r=t.c;return e=Re[r],function(t,r){if(e(t)){var n=t.memory.read(r+1);t.tick(1);var i=t.memory.read(r+2);t.tick(2);var a=n|i<<8,s=r+3,o=t.registers[T];t.memory.write(o-1,s>>>8&255),t.tick(1),t.memory.write(o-2,255&s),t.tick(2);var c=o-2&65535;t.registers[T]=c,t.skip(3),t.registers[R]=a,t.isDebugging&&t.log("op","call ".concat(e.name,", ").concat(j(a)),r,"pc=".concat(j(a)," sp=").concat(j(c)))}else if(t.skip(3),t.tick(3),t.isDebugging){var u=t.memory.read(r+1)|t.memory.read(r+2)<<8;t.log("op","call ".concat(e.name,", ").concat(j(u)),r,"skip")}}}],["11000011",function(){return Te}],["11001001",function(){return ze}],["11011001",function(){return je}],["11001011",function(){return mr}],["11001101",function(){return Oe}],["11DD0001",function(t){var e,r=t.D;return e=pr[r],function(t,r){var n=t.registers[T],i=t.memory.read(n);t.tick(1);var a=t.memory.read(n+1);t.tick(2);var s=i|a<<8;e.write(t,s),t.registers[T]+=2,t.skip(1),e.postCallback(t),t.isDebugging&&t.log("op","pop ".concat(e.name),r,"".concat(e.name,"=").concat(j(s)," sp=").concat(j(n)))}}],["11DD0101",function(t){var e,r=t.D;return e=pr[r],function(t,r){t.tick(1);var n=e.read(t),i=t.registers[T]-2;t.memory.write(i+1,n>>>8&255),t.tick(1),t.memory.write(i,255&n),t.tick(2),t.registers[T]=i,t.skip(1),e.postCallback(t),t.isDebugging&&t.log("op","push ".concat(e.name),r,"".concat(e.name,"=").concat(j(n)," sp=").concat(j(i)))}}],["11ooo110",function(t){var e,r=t.o;return e=ye[r],function(t,r){var n=t.registers[E],i=t.memory.read(r+1),a=e(t,n,i);t.registers[E]=a,t.skip(2),t.tick(2),t.isDebugging&&t.log("op","".concat(e.opName," ").concat(N(i)),r,"a=".concat(N(a)," (").concat(N(n),") ").concat(t.getDebugFlags()))}}],["11nnn111",function(t){return function(t){return function(e,r){e.tick(1);var n=r+1,i=e.registers[T];e.memory.write(i-1,n>>>8&255),e.tick(1),e.memory.write(i-2,255&n),e.tick(2);var a=i-2&65535;e.registers[T]=a,e.skip(1),e.registers[R]=t,e.isDebugging&&e.log("op","rst ".concat(N(t)),r,"pc=".concat(j(t)," sp=").concat(j(a)))}}(t.n<<3)}],["11100000",function(){return We}],["11110000",function(){return He}],["11100010",function(){return Ue}],["11110010",function(){return Fe}],["11101000",function(){return Ke}],["11111000",function(){return qe}],["11101001",function(){return Le}],["11111001",function(){return Ve}],["11101010",function(){return Pe}],["11111010",function(){return Ne}],["11110011",function(){return er}],["11111011",function(){return rr}]]),br=function(){function t(e){c(this,t),this.registers=[0,0,0,0,0,0,0,0,0,0,0],this.clocks=0,this.memory=void 0,this.onTick=void 0,this.isRunning=!1,this.isStopped=!1,this.isBlocked=!1,this.isInterruptsEnabled=!1,this.isInterruptsEnabledNext=!1,this.isTrapped=!1,this.isTrapResolved=!1,this.isDebugging=!1,this.debugLogs=[],this.opSizes=new Uint8Array(65536),this.isBreakpointsEnabled=!1,this.breakpoints=[],this.readBreakpoints=[],this.writeBreakpoints=[],this.memory=e,this.reset([0,0,0,0,0,0,0,0,0,0,0]),this.onTick=function(){}}return h(t,[{key:"reset",value:function(t){this.registers=t.slice(),this.clocks=0,this.isStopped=!1,this.isBlocked=!1,this.isInterruptsEnabled=!1,this.isInterruptsEnabledNext=!1,this.isDebugging=!1,this.debugLogs=[],this.opSizes.fill(0)}},{key:"resume",value:function(){this.isStopped=!1,this.isRunning=!0}},{key:"serialize",value:function(){var t={};return t.registers=oe(this.registers),t.clocks=this.clocks,t.isRunning=this.isRunning,t.isInterruptsEnabled=this.isInterruptsEnabled,t.isInterruptsEnabledNext=this.isInterruptsEnabledNext,t}},{key:"deserialize",value:function(t){this.registers=oe(t.registers),this.clocks=t.clocks,this.isRunning=t.isRunning,this.isInterruptsEnabled=t.isInterruptsEnabled,this.isInterruptsEnabledNext=t.isInterruptsEnabledNext}},{key:"getDebugFlags",value:function(){var t=[];return t.push(this.getFlag(z)?"Z":"-"),t.push(this.getFlag(x)?"N":"-"),t.push(this.getFlag(O)?"H":"-"),t.push(this.getFlag(L)?"C":"-"),t.join("")}},{key:"readHL",value:function(){return this.registers[A]<<8|this.registers[M]}},{key:"writeHL",value:function(t){this.registers[A]=t>>>8&255,this.registers[M]=255&t}},{key:"getFlag",value:function(t){return 0!==(this.registers[I]&1<<t)}},{key:"aluSetFlags",value:function(t,e,r,n){var i=0;t&&(i|=1<<z),e&&(i|=1<<x),r&&(i|=1<<O),n&&(i|=1<<L),this.registers[I]=i}},{key:"skip",value:function(t){var e=this.registers[R];this.opSizes[e]=t,this.registers[R]=e+t&65535}},{key:"jump",value:function(t){this.registers[R]=65535&t}},{key:"tick",value:function(t){this.clocks+=t,this.onTick(t)}},{key:"log",value:function(t,e,r,n){this.debugLogs.push({type:t,data:e,address:r,comment:n}),this.debugLogs.length>1e3&&this.debugLogs.shift()}},{key:"trap",value:function(){this.isTrapped=!0}},{key:"enterInterrupt",value:function(){this.isInterruptsEnabled=!1,this.isInterruptsEnabledNext=!1;var t=this.registers[R],e=this.registers[T];this.memory.write(e-1,t>>>8&255),this.memory.write(e-2,255&t),this.registers[T]=this.registers[T]-2&65535,this.tick(5)}},{key:"getDebugState",value:function(){return["PC: ".concat(this.registers[R].toString(16).padStart(4,"0")," SP: ").concat(this.registers[T].toString(16).padStart(4,"0")),"A: ".concat(this.registers[E].toString(16).padStart(4,"0")," BC: ").concat((this.registers[C]<<8|this.registers[D]).toString(16).padStart(4,"0")),"DE: ".concat((this.registers[_]<<8|this.registers[B]).toString(16).padStart(4,"0")," HL: ").concat((this.registers[A]<<8|this.registers[M]).toString(16).padStart(4,"0")),"Z: ".concat(this.getFlag(z)," N: ").concat(this.getFlag(x)," H: ").concat(this.getFlag(O)," C: ").concat(this.getFlag(L))].join("\n")}},{key:"step",value:function(){if(this.isBlocked)this.tick(1);else{this.isInterruptsEnabled=this.isInterruptsEnabledNext;var t=this.registers[R];if(!this.isTrapResolved&&this.isBreakpointsEnabled&&this.breakpoints.includes(t))return this.isTrapped=!0,void(this.isDebugging=!0);this.isTrapResolved=!1;var e=this.memory.read(t),r=yr[e];null!=r?r(this,t):(this.skip(1),this.tick(1))}}},{key:"runUntilHalt",value:function(){for(this.isRunning=!0;this.isRunning;)this.step()}}]),t}(),kr={read:function(){return 255},write:function(){}},wr=function(){function t(){c(this,t),this.ports=void 0,this.names=void 0,this.offsets=void 0,this.ports=[],this.names=[],this.offsets=[],this.reset()}return h(t,[{key:"reset",value:function(){this.ports=Array.from({length:256},(function(){return kr})),this.names=Array.from({length:256},(function(){return null})),this.offsets=Array.from({length:256},(function(){return 0}))}},{key:"register",value:function(t,e,r){this.ports[t]=r,this.names[t]=e,this.offsets[t]=0}},{key:"registerMemory",value:function(t,e,r,n){for(var i=0;i<e;i+=1)this.ports[t+i]=n,this.names[t+i]=r,this.offsets[t+i]=t}},{key:"read",value:function(t){var e=this.ports[t];if(null==e)return 255;var r=this.offsets[t];return e.read(t-r)}},{key:"write",value:function(t,e){var r=this.ports[t];if(null!=r){var n=this.offsets[t];r.write(t-n,e)}}}]),t}(),Sr={read:function(){return 255},write:function(){}},Er=function(){function t(){c(this,t),this.ports=void 0,this.offsets=void 0,this.ports=[],this.offsets=[],this.reset()}return h(t,[{key:"reset",value:function(){this.ports=Array.from({length:256},(function(){return Sr})),this.offsets=Array.from({length:256},(function(){return 0}))}},{key:"register",value:function(t,e,r,n){for(var i=t;i<=e;i+=1)this.ports[i]=r,this.offsets[i]=null!==n&&void 0!==n?n:t<<8}},{key:"read",value:function(t){var e=t>>>8,r=this.ports[e];return null==r?255:r.read(t-this.offsets[e])}},{key:"write",value:function(t,e){var r=t>>>8,n=this.ports[r];null!=n&&n.write(t-this.offsets[r],e)}}]),t}(),Cr=function(){function t(){c(this,t),this.cpu=void 0,this.interrupter=void 0,this.memoryBus=void 0,this.ioBus=void 0,this.type=void 0,this.memoryBus=new Er,this.cpu=new br(this.memoryBus),this.interrupter=new K(this.cpu),this.ioBus=new wr,this.type=F.DMG,this.reset()}return h(t,[{key:"serialize",value:function(){return{cpu:this.cpu.serialize(),interrupter:this.interrupter.serialize()}}},{key:"deserialize",value:function(t){this.cpu.deserialize(t.cpu),this.interrupter.deserialize(t.interrupter)}},{key:"reset",value:function(t){null!=t&&(this.type=t),this.cpu.reset(X[this.type]),this.memoryBus.reset(),this.ioBus.reset(),this.interrupter.reset(),this.memoryBus.register(255,255,this.ioBus),this.interrupter.register(this)}}]),t}(),Dr=function(){function t(){c(this,t),this.src=0,this.pos=-1,this.system=null}return h(t,[{key:"serialize",value:function(){return{src:this.src,pos:this.pos}}},{key:"deserialize",value:function(t){this.src=t.src,this.pos=t.pos}},{key:"reset",value:function(){this.src=0,this.pos=-1}},{key:"register",value:function(t){var e=this;t.ioBus.register(70,"DMA",{read:function(){return 255},write:function(t,r){var n=r<<8;e.src=n,e.pos=0}}),this.system=t}},{key:"advanceClock",value:function(){if(null!=this.system&&this.pos>=0){var t=this.system.memoryBus,e=t.read(this.src+this.pos);t.write(65024+this.pos,e),this.pos+=1,this.pos>=160&&(this.pos=-1)}}}]),t}(),_r=0,Br=1,Ir=2,Ar=3,Mr=4,Rr=5,Tr=6,Lr=7,xr=function(){function t(){c(this,t),this.selectedNibbleHigh=!1,this.buttons=void 0,this.system=null,this.reset()}return h(t,[{key:"reset",value:function(){this.selectedNibbleHigh=!1,this.buttons=[!1,!1,!1,!1,!1,!1,!1,!1]}},{key:"register",value:function(t){var e=this;this.system=t,t.ioBus.register(0,"JOYP",{read:function(){var t=0,r=e.selectedNibbleHigh?4:0;return e.buttons[r+0]||(t|=1),e.buttons[r+1]||(t|=2),e.buttons[r+2]||(t|=4),e.buttons[r+3]||(t|=8),t},write:function(t,r){0===(32&r)?e.selectedNibbleHigh=!0:0===(16&r)&&(e.selectedNibbleHigh=!1)}})}},{key:"set",value:function(t,e){null!=this.system&&this.system.interrupter.queueInterrupt(G),this.buttons[t]=e}}]),t}(),Or=["src","dest","useHBlank","isRunning","length","pos"],zr=function(){function t(){c(this,t),this.src=0,this.dest=0,this.useHBlank=!1,this.isRunning=!1,this.length=0,this.pos=0,this.remainingInCycle=0,this.system=null,this.emulator=null}return h(t,[{key:"serialize",value:function(){var t=this,e={};return Or.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Or.forEach((function(r){return e[r]=t[r]}))}},{key:"reset",value:function(){this.src=0,this.dest=0,this.useHBlank=!1,this.isRunning=!1,this.length=0,this.pos=0}},{key:"register",value:function(t,e){var r=this;if(this.system=t,this.emulator=e,t.type===F.CGB){var n=t.ioBus;n.register(81,"HDMA1",{read:function(){return r.src>>>8&255},write:function(t,e){r.src=255&r.src|e<<8}}),n.register(82,"HDMA2",{read:function(){return 255&r.src},write:function(t,e){r.src=65280&r.src|e}}),n.register(83,"HDMA3",{read:function(){return r.dest>>>8&255},write:function(t,e){r.dest=255&r.dest|e<<8}}),n.register(84,"HDMA4",{read:function(){return 255&r.dest},write:function(t,e){r.dest=65280&r.dest|e}}),n.register(85,"HDMA5",{read:function(){var t=r.length-r.pos;if(0===t)return 255;var e=127&Math.floor(t/16);return r.isRunning||(e|=128),e},write:function(t,e){r.isRunning?(r.isRunning=!1,r.system.cpu.isBlocked=!1):(r.isRunning=!0,r.useHBlank=0!==(128&e),r.pos=0,r.length=16*(1+(127&e)),r.useHBlank?0===r.emulator.ppu.mode?(r.remainingInCycle=16,r.system.cpu.isBlocked=!0):r.remainingInCycle=0:0!==(128&r.system.memoryBus.read(65357))?r.system.cpu.tick(r.length):r.system.cpu.tick(r.length/2))}})}}},{key:"enterHBlank",value:function(){this.isRunning&&this.useHBlank&&(this.remainingInCycle=16,this.system.cpu.isBlocked=!0)}},{key:"advanceClock",value:function(){if(this.isRunning){if(this.useHBlank)if(0!==this.emulator.ppu.mode||this.remainingInCycle<=0)return void(this.system.cpu.isBlocked=!1);for(var t=this.system.cpu.memory,e=this.src,r=this.dest,n=this.length,i=65520&e,a=32768+(8176&r),s=0;s<2;s+=1){var o=this.pos,c=t.read(i+o);if(t.write(a+o,c),this.pos+=1,this.remainingInCycle-=1,this.pos===n){this.system.cpu.isBlocked=!1,this.isRunning=!1,this.pos=0,this.length=0;break}}}}}]),t}(),jr=function(){function t(){c(this,t),this.system=void 0,this.isDoubleSpeed=void 0,this.shouldChangeSpeed=void 0,this.system=null,this.isDoubleSpeed=!1,this.shouldChangeSpeed=!1}return h(t,[{key:"serialize",value:function(){return{isDoubleSpeed:this.isDoubleSpeed,shouldChangeSpeed:this.shouldChangeSpeed}}},{key:"deserialize",value:function(t){this.isDoubleSpeed=t.isDoubleSpeed,this.shouldChangeSpeed=t.shouldChangeSpeed}},{key:"register",value:function(t){var e=this;(this.system=t,t.type===F.CGB)&&t.ioBus.register(77,"KEY1",{read:function(){var t=0;return e.isDoubleSpeed&&(t|=128),e.shouldChangeSpeed&&(t|=1),t},write:function(t,r){e.shouldChangeSpeed=0!==(1&r)}})}},{key:"reset",value:function(){this.isDoubleSpeed=!1,this.shouldChangeSpeed=!1}},{key:"advanceClock",value:function(){null!=this.system&&this.shouldChangeSpeed&&!this.system.cpu.isRunning&&(this.isDoubleSpeed=!this.isDoubleSpeed,this.shouldChangeSpeed=!1,this.system.cpu.tick(2050),this.system.cpu.isRunning=!0)}}]),t}(),Nr=[1024,16,64,256],Pr=[512,8,32,128],Fr=["clocks","tima","tma","tac","timaDelayed"],Ur=function(){function t(e){c(this,t),this.interrupter=void 0,this.clocks=0,this.tima=0,this.tma=0,this.tac=0,this.timaDelayed=!1,this.interrupter=e,this.reset()}return h(t,[{key:"reset",value:function(){this.clocks=42752,this.tima=0,this.tma=0,this.tac=0,this.timaDelayed=!1}},{key:"register",value:function(t){var e=this,r=t.ioBus;r.register(4,"DIV",{read:function(){return e.clocks/256&255},write:function(){(e.clocks=0,4&e.tac)&&(e.clocks&Pr[3&e.tac]&&(e.tima+=1,e._postUpdateTIMA()))}}),r.register(5,"TIMA",{read:function(){return 255&e.tima},write:function(t,r){return e.tima=r}}),r.register(6,"TMA",{read:function(){return e.tma},write:function(t,r){return e.tma=r}}),r.register(7,"TAC",{read:function(){return e.tac},write:function(t,r){var n=e.tac;if(e.tac=r,4&n){var i=e.clocks&Pr[3&n];!(e.clocks&Pr[3&r])&&i&&(e.tima+=1,e._postUpdateTIMA())}}})}},{key:"serialize",value:function(){var t=this,e={};return Fr.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Fr.forEach((function(r){return e[r]=t[r]}))}},{key:"getDebugState",value:function(){var t=this.clocks/256&255;return["DIV: ".concat(t.toString(16).padStart(2,"0")," TIMA: ").concat((255&this.tima).toString(16).padStart(2,"0")," TMA: ").concat(this.tma.toString(16).padStart(2,"0")," TAC: ").concat(this.tac.toString(16).padStart(2,"0"))].join("\n")}},{key:"getNextWakeupClockAdvance",value:function(){if(4&this.tac){var t=Nr[3&this.tac];return(this.clocks-this.clocks%t+(256-this.tima)*t-this.clocks)/4+1}return 2147483647}},{key:"_postUpdateTIMA",value:function(){this.tima>255&&(this.timaDelayed=!0,this.tima=256)}},{key:"advanceClock",value:function(){if(this.timaDelayed&&(this.timaDelayed=!1,this.tima>255&&(this.tima=255&this.tma,this.interrupter.queueInterrupt(H))),4&this.tac){var t=Pr[3&this.tac],e=0!==(this.clocks&t),r=0!==(this.clocks+4&t);e&&!r&&(this.tima+=1,this._postUpdateTIMA())}this.clocks+=4}}]),t}(),Wr=["data","inProgress","isFast","isExternal"],Hr=function(){function t(){c(this,t),this.data=0,this.inProgress=!1,this.isFast=!1,this.isExternal=!1,this.system=null}return h(t,[{key:"serialize",value:function(){var t=this,e={};return Wr.forEach((function(r){return e[r]=t[r]})),e}},{key:"deserialize",value:function(t){var e=this;Wr.forEach((function(r){return e[r]=t[r]}))}},{key:"reset",value:function(){this.data=0,this.inProgress=!1,this.isFast=!1,this.isExternal=!1}},{key:"register",value:function(t){var e=this;this.system=t;var r=t.ioBus;r.register(1,"SB",{read:function(){return e.data},write:function(t,r){e.data=r}}),r.register(2,"SC",{read:function(){return 0},write:function(t,e){}})}}]),t}(),Gr=function(){function t(){c(this,t),this.system=void 0,this.ppu=void 0,this.apu=void 0,this.timer=void 0,this.gamepad=void 0,this.wram=void 0,this.hram=void 0,this.dma=void 0,this.hdma=void 0,this.speed=void 0,this.serial=void 0,this.cartridge=void 0,this.system=new Cr,this.ppu=new ft(this.system.interrupter),this.apu=new ae,this.timer=new Ur(this.system.interrupter),this.gamepad=new xr,this.wram=new se,this.hram=new w(128),this.dma=new Dr,this.hdma=new zr,this.speed=new jr,this.serial=new Hr,this.cartridge=null}return h(t,[{key:"serialize",value:function(){return It(It({},this.system.serialize()),{},{ppu:this.ppu.serialize(),apu:this.apu.serialize(),timer:this.timer.serialize(),wram:this.wram.serialize(),hram:this.hram.serialize(),dma:this.dma.serialize(),hdma:this.hdma.serialize(),speed:this.speed.serialize(),serial:this.serial.serialize(),cartridge:this.cartridge.mbc.serialize()})}},{key:"deserialize",value:function(t){this.system.deserialize(t),this.ppu.deserialize(t.ppu),this.apu.deserialize(t.apu),this.timer.deserialize(t.timer),this.wram.deserialize(t.wram),this.hram.deserialize(t.hram),this.dma.deserialize(t.dma),this.hdma.deserialize(t.hdma),this.speed.deserialize(t.speed),this.serial.deserialize(t.serial),this.cartridge.mbc.deserialize(t.cartridge)}},{key:"reset",value:function(t){this.system.reset(t),this.wram.reset(),this.hram.reset(),this.ppu.reset(),this.apu.reset(),this.timer.reset(),this.gamepad.reset(),this.dma.reset(),this.hdma.reset(),this.speed.reset(),this.serial.reset(),null!=this.cartridge&&this.cartridge.reset(),this.wram.register(this.system),this.ppu.register(this.system,this),this.apu.register(this.system),this.timer.register(this.system),this.gamepad.register(this.system),this.system.ioBus.registerMemory(128,127,"HRAM",this.hram),this.dma.register(this.system),this.hdma.register(this.system,this),this.speed.register(this.system),this.serial.register(this.system),null!=this.cartridge&&this.cartridge.register(this.system),this.system.cpu.onTick=this.advanceClocks.bind(this),this.system.cpu.jump(256),this.system.cpu.isRunning=!0}},{key:"advanceClocks",value:function(t){for(var e=this.system.cpu.clocks-t,r=0;r<t;r+=1)this.timer.advanceClock(),this.dma.advanceClock(),this.speed.advanceClock(),this.speed.isDoubleSpeed&&e%2!==0||(this.ppu.advanceClock(),this.apu.advanceClock(),this.hdma.advanceClock()),e+=1}}]),t}(),Vr=function(){function t(e){c(this,t),this.emulator=void 0,this.isRunning=void 0,this.isStepping=void 0,this.sramSaveTimer=0,this.canvas=void 0,this.ctx=void 0,this.debugTextElem=null,this.emulator=new Gr,this.isRunning=!1,this.isStepping=!1,this.sramSaveTimer=0,this.canvas=e,this.ctx=e.getContext("2d")}return h(t,[{key:"load",value:function(){var t=o(a().mark((function t(e){var r,n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Lt(this.emulator.system.cpu,e);case 2:return r=t.sent,t.next=5,jt(r.info);case 5:null!=(n=t.sent)&&r.mbc.loadRAM(n),this.emulator.cartridge=r,this.reboot(r.info.supportsCGB?F.CGB:F.DMG);case 9:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"loadSRAMFromFile",value:function(t){var e=this.emulator.cartridge;null!=e&&e.mbc.loadRAM(t)}},{key:"getSRAM",value:function(){var t=this.emulator.cartridge;return null==t?null:t.mbc.serializeRAM()}},{key:"saveSRAM",value:function(){var t=o(a().mark((function t(){var e,r;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!=(e=this.emulator.cartridge)){t.next=3;break}return t.abrupt("return");case 3:if(null!=(r=e.mbc.serializeRAM())){t.next=6;break}return t.abrupt("return");case 6:return t.next=8,Pt(e.info,r);case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"serialize",value:function(){return this.emulator.serialize()}},{key:"deserialize",value:function(t){this.emulator.deserialize(t)}},{key:"reboot",value:function(t){this.emulator.reset(t),this.sramSaveTimer=0}},{key:"start",value:function(){this.isRunning=!0}},{key:"stop",value:function(){this.isRunning=!1}},{key:"readStack",value:function(t){for(var e=[],r=this.emulator.system.cpu.registers[T],n=0;n<t;n+=1)e.push(this.emulator.system.cpu.memory.read(r+n).toString(16).padStart(2,"00"));return e.join(" ")}},{key:"update",value:function(){if(this.isRunning&&null!=this.emulator.cartridge){var t=this.emulator,r=t.ppu,n=t.timer,i=t.apu,a=t.cartridge,s=t.speed,o=this.emulator.system,c=o.cpu,u=o.interrupter;this.isStepping?(c.isDebugging=!0,c.debugLogs=[]):c.isDebugging=!1;var l=this.emulator.ppu.getRemainingClockUntilVblank();s.isDoubleSpeed&&(l*=2);var h=c.clocks+l;for(this.isStepping&&(h=c.clocks+1,this.isRunning=!1,c.isTrapResolved=!0,c.isTrapped=!1);c.clocks<h&&(c.isRunning||u.acceptsInterrupt())&&!c.isTrapped;){var f=c.clocks;u.step();var d=c.clocks-f;if(0===d){var v=Math.min(r.getNextWakeupClockAdvance(),n.getNextWakeupClockAdvance());if(0===v)break;d=v,s.isDoubleSpeed&&(d*=2),c.tick(d)}}if(this.isStepping){var p,g=function(t,r){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=e(t))||r&&t&&"number"===typeof t.length){n&&(t=n);var i=0,a=function(){};return{s:a,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){c=!0,s=t},f:function(){try{o||null==n.return||n.return()}finally{if(c)throw s}}}}(c.debugLogs);try{for(g.s();!(p=g.n()).done;){var m,y,b=p.value;if(null!=b.address)console.log("%c%s: %c%s; %c%s","color: #468cff",j(b.address),"color: inherit",b.data,"color: gray",null!==(m=b.comment)&&void 0!==m?m:"");else console.log(b.data,null!==(y=b.comment)&&void 0!==y?y:"")}}catch(k){g.e(k)}finally{g.f()}c.debugLogs=[]}null!=this.debugTextElem&&(this.debugTextElem.innerText=["--------- CPU","CLK: ".concat(c.clocks),c.getDebugState(),u.getDebugState(),"--------- PPU",r.getDebugState(),"--------- TIMER",n.getDebugState(),"--------- CART","Cartridge: ".concat(a.info.title),a.mbc.getDebugState(),"--------- APU",i.getDebugState(),"--------- STACK","Stack: ".concat(this.readStack(20))].join("\n")),function(t,e){for(var r,n=e.createImageData(ut,lt),i=n.data,a=0;a<lt;a+=1)for(var s=0;s<ut;s+=1){var o=32768&(r=t.framebuffer[a*ut+s])?kt[3&r]:(255*(31&r)/31|0)<<24|(255*(r>>5&31)/31|0)<<16|(255*(r>>10&31)/31|0)<<8|255;i[4*(a*ut+s)]=o>>>24&255,i[4*(a*ut+s)+1]=o>>>16&255,i[4*(a*ut+s)+2]=o>>>8&255,i[4*(a*ut+s)+3]=255&o}e.putImageData(n,0,0)}(r,this.ctx),this.isStepping||(i.finalize(),a.mbc.ramUpdated&&(this.sramSaveTimer=100,a.mbc.ramUpdated=!1),this.sramSaveTimer>0&&(this.sramSaveTimer-=1,0===this.sramSaveTimer&&this.saveSRAM()))}}}]),t}();function qr(t,e){var r=new Blob([e]),n=URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download=t,document.body.appendChild(i),i.style.display="none",i.click(),i.remove()}var Yr,Kr={z:Rr,x:Mr,Enter:Lr,Backspace:Tr,ArrowUp:Ir,ArrowLeft:Br,ArrowRight:_r,ArrowDown:Ar};function Jr(t,e){if(e.name.endsWith(".state")){var r=new FileReader;r.onload=function(){var e=o(a().mark((function e(r){var n,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r.target.result,i=JSON.parse(n),Yr=i,t.deserialize(i);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r.readAsText(e)}else{var n=new FileReader;n.onload=function(){var r=o(a().mark((function r(n){var i,s;return a().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=n.target.result,s=new Uint8Array(i),!e.name.endsWith(".sav")){r.next=8;break}t.loadSRAMFromFile(s),t.reboot(),t.start(),r.next=12;break;case 8:return r.next=10,t.load(s);case 10:t.reboot(),t.start();case 12:case"end":return r.stop()}}),r)})));return function(t){return r.apply(this,arguments)}}(),n.readAsArrayBuffer(e)}}var Xr={open:function(t){var e=document.createElement("input");e.type="file",e.accept=".gb,.gbc,.sav,.state",e.click(),e.addEventListener("change",(function(){var r,n=(null!==(r=e.files)&&void 0!==r?r:[])[0];null!=n&&Jr(t,n)}))},play:function(t){t.isRunning=!t.isRunning,t.isStepping=!1,t.emulator.system.cpu.isTrapped&&(t.isRunning=!0,t.emulator.system.cpu.isTrapResolved=!0,t.emulator.system.cpu.isTrapped=!1)},reset:function(t){t.reboot(),t.start()},stepFrame:function(t){t.isRunning=!0,t.isStepping=!1,t.update(),t.isRunning=!1},stepClock:function(t){t.isRunning=!0,t.isStepping=!0},loadState:function(t){null!=Yr&&t.deserialize(Yr)},saveState:function(t){var e=t.serialize();Yr=e},downloadState:function(t){null!=Yr&&qr(t.emulator.cartridge.info.title+".state",JSON.stringify(Yr))},downloadSave:function(t){var e=t.getSRAM();null!=e&&qr(t.emulator.cartridge.info.title+".sav",e)},toggleDebugStats:function(t){var e=document.querySelector("#debug-stats-txt");null==t.debugTextElem?(t.debugTextElem=e,e.style.display="block"):(t.debugTextElem=null,e.style.display="none")},dumpVRAM:function(t){mt(t.emulator.ppu)}},Qr=1e3/60;!function(){var t,e=performance.now(),r=document.querySelector("#canvas");r.width=ut,r.height=lt;var i=new Vr(r);window.emulator=i,requestAnimationFrame((function t(){if(document.hidden)requestAnimationFrame(t);else{for(var r=performance.now()-e,n=Math.min(10,Math.floor(r/Qr)),a=0;a<n;a+=1)i.update(),e+=Qr;10===n&&(e=performance.now()),requestAnimationFrame(t)}})),window.addEventListener("keydown",(function(t){switch(t.key){case" ":Xr.play(i);break;case"q":Xr.stepFrame(i);break;case"w":Xr.stepClock(i);break;case"e":Xr.dumpVRAM(i);break;case"o":i.emulator.system.cpu.isBreakpointsEnabled=!i.emulator.system.cpu.isBreakpointsEnabled;break;case"p":Xr.toggleDebugStats(i);break;case"1":Xr.saveState(i);break;case"2":Xr.loadState(i)}var e=Kr[t.key];null!=e&&(t.preventDefault(),i.emulator.gamepad.set(e,!0))})),window.addEventListener("keyup",(function(t){var e=Kr[t.key];null!=e&&(t.preventDefault(),i.emulator.gamepad.set(e,!1))})),window.addEventListener("dragover",(function(t){t.preventDefault()})),window.addEventListener("drop",(function(t){var e,r;t.stopPropagation(),t.preventDefault();var n=null!==(e=null===(r=t.dataTransfer)||void 0===r?void 0:r.files)&&void 0!==e?e:[];null!=n[0]&&Jr(i,n[0])})),window.addEventListener("click",o(a().mark((function t(){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i.emulator.apu.setup();case 1:case"end":return t.stop()}}),t)})))),[["#open","open"],["#download-sav","downloadSave"],["#play","play"],["#reset","reset"],["#step-frame","stepFrame"],["#download-state","downloadState"],["#toggle-debug-stats","toggleDebugStats"],["#dump-vram","dumpVRAM"]].forEach((function(t){var e,r=n(t,2),a=r[0],s=r[1];null===(e=document.querySelector(a))||void 0===e||e.addEventListener("click",(function(){Xr[s](i)}))})),null===(t=document.querySelector("#open"))||void 0===t||t.addEventListener("click",(function(){Xr.open(i)}))}()}()}();
//# sourceMappingURL=main.8fd22d89.js.map